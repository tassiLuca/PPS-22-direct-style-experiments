<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Channels as a communication primitive # Channels as a communication primitive Introduction Analyzer example Future monadic version Scala Gears version Kotlin Coroutines version Introducing Flows in Gears Showcasing Flows Takeaways Introduction # The fourth, yet not mentioned, abstraction of both Kotlin Coroutines and Scala Gears is the channel. Channels represent the primitive communication and coordination means to exchange Future (or coroutines in the case of Kotlin) results. They are, at least conceptually, very similar to a queue where it is possible to send (and receive) data &ndash; basically, exploiting the producer-consumer pattern.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="" />
<meta property="og:description" content="Channels as a communication primitive # Channels as a communication primitive Introduction Analyzer example Future monadic version Scala Gears version Kotlin Coroutines version Introducing Flows in Gears Showcasing Flows Takeaways Introduction # The fourth, yet not mentioned, abstraction of both Kotlin Coroutines and Scala Gears is the channel. Channels represent the primitive communication and coordination means to exchange Future (or coroutines in the case of Kotlin) results. They are, at least conceptually, very similar to a queue where it is possible to send (and receive) data &ndash; basically, exploiting the producer-consumer pattern." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tassiluca.github.io/direct-style-experiments/docs/04-channels/" /><meta property="article:section" content="docs" />

<meta property="article:modified_time" content="2024-03-09T16:35:50+01:00" />
<title>04 Channels | direct-style-experiments</title>
<link rel="manifest" href="/direct-style-experiments/manifest.json">
<link rel="icon" href="/direct-style-experiments/favicon.png" >
<link rel="canonical" href="https://tassiluca.github.io/direct-style-experiments/docs/04-channels/">
<link rel="stylesheet" href="/direct-style-experiments/book.min.42504dd4648e8da78376617fd32b73c3ae6afbe9f805c36868bc831b07002332.css" integrity="sha256-QlBN1GSOjaeDdmF/0ytzw65q&#43;&#43;n4BcNoaLyDGwcAIzI=" crossorigin="anonymous">
  <script defer src="/direct-style-experiments/flexsearch.min.js"></script>
  <script defer src="/direct-style-experiments/en.search.min.0a53d30665124409e5805f451a4cb784495cc6887fc81a30b7e8f9f397def877.js" integrity="sha256-ClPTBmUSRAnlgF9FGky3hElcxoh/yBowt&#43;j585fe&#43;Hc=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/direct-style-experiments/"><span>direct-style-experiments</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/direct-style-experiments/docs/01-overview/" class="">01 Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/direct-style-experiments/docs/02-boundaries/" class="">02 Boundaries</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/direct-style-experiments/docs/03-basics/" class="">03 Basics</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/direct-style-experiments/docs/04-channels/" class="active">04 Channels</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/direct-style-experiments/docs/05-rears/" class="">05 Rears</a>
  

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/direct-style-experiments/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>04 Channels</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="channels-as-a-communication-primitive">
  Channels as a communication primitive
  <a class="anchor" href="#channels-as-a-communication-primitive">#</a>
</h1>
<ul>
<li><a href="#channels-as-a-communication-primitive">Channels as a communication primitive</a>
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#analyzer-example">Analyzer example</a>
<ul>
<li><a href="#future-monadic-version">Future monadic version</a></li>
<li><a href="#scala-gears-version">Scala Gears version</a></li>
<li><a href="#kotlin-coroutines-version">Kotlin Coroutines version</a></li>
</ul>
</li>
<li><a href="#introducing-flows-in-gears">Introducing <code>Flow</code>s in Gears</a>
<ul>
<li><a href="#showcasing-flows">Showcasing <code>Flow</code>s</a></li>
</ul>
</li>
<li><a href="#takeaways">Takeaways</a></li>
</ul>
</li>
</ul>
<h2 id="introduction">
  Introduction
  <a class="anchor" href="#introduction">#</a>
</h2>
<p>The fourth, yet not mentioned, abstraction of both Kotlin Coroutines and Scala Gears is the <strong>channel</strong>.
Channels represent the <strong>primitive communication and coordination means</strong> to exchange <code>Future</code> (or coroutines in the case of Kotlin) results. They are, at least conceptually, very similar to a queue where it is possible to send (and receive) data &ndash; basically, exploiting the <em><strong>producer-consumer</strong></em> pattern.</p>
<figure class="center"><img src="../../res/img/channel.svg"
    alt="Channel">
</figure>



<script src="/direct-style-experiments/mermaid.min.js"></script>

  <script>mermaid.initialize({
    "flowchart": {
        "useMaxWidth":true
    },
    "theme": "default"
})</script>




<p class="mermaid">
classDiagram
  class `SendableChannel[-T]` {
    << trait >>
    +sendSource(x: T) Async.Source[Either[Closed, Unit]]
    +send(x: T)(using Async) Unit
  }

  class `ReadableChannel[+T]` {
    << trait >>
    +readSource Async.Source[Either[Closed, T]]
    +read()(using Async) Either[Closed, T]
  }

  class `Channel[T]` {
    << trait >>
    +asSendable: SendableChannel[T]
    +asReadable: ReadableChannel[T]
    +asCloseable: java.io.Closeable
  }

  namespace java io {
    class Closeable {
      << interface >>
      +close()
    }
  }

  `SendableChannel[-T]` <|-- `Channel[T]`
  Closeable <|-- `Channel[T]`
  `ReadableChannel[+T]` <|-- `Channel[T]`
</p>

<p>The channel is defined through three distinct interfaces: <code>SendableChannel[-T]</code>, <code>ReadableChannel[+T]</code> and <code>Channel[T]</code>, where the latter extends from both <code>SendableChannel</code> and <code>ReadableChannel</code>. Typically, a <code>Channel</code> is created and a <code>SendableChannel</code> and <code>ReadableChannel</code> instances are respectively provided to the producer and the consumer, restricting their access to it. The same, almost identical, design is present also in Kotlin Coroutines where <code>SendChannel</code> and <code>ReceiveChannel</code> take over, respectively, the Gears <code>SendableChannel</code> and <code>ReadableChannel</code>.</p>
<blockquote class="book-hint warning">
  <code>Channel</code> inherits from <code>java.io.Closable</code>, making them closable objects: once closed, they raise <code>ChannelClosedException</code> when attempting to write to them and immediately return a <code>Left(Closed)</code> when attempting to read from them, preventing the consumer from finishing reading all the values sent on the channel before its closing.
This is not the case for Kotlin Coroutines where closing a channel indicates that no more values are coming, but doesn&rsquo;t prevent consuming already sent values. Moreover, in Kotlin is possible to use a regular for loop to receive elements from a channel (blocking the coroutine):
</blockquote>

<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">val</span> <span style="color:#fe640b">channel</span> = Channel&lt;Int&gt;()
</span></span><span style="display:flex;"><span>launch {
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">for</span> (x <span style="color:#8839ef">in</span> <span style="color:#fe640b">1.</span>.<span style="color:#fe640b">5</span>) channel.send(x * x)
</span></span><span style="display:flex;"><span>    channel.close() <span style="color:#9ca0b0;font-style:italic">// we&#39;re done sending
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>}
</span></span><span style="display:flex;"><span><span style="color:#8839ef">for</span> (y <span style="color:#8839ef">in</span> channel) println(y) <span style="color:#9ca0b0;font-style:italic">// blocks until channel is closed
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>println(<span style="color:#40a02b">&#34;Done!&#34;</span>)
</span></span></code></pre></div><blockquote class="book-hint info">
  Similar behavior can be achieved also in Gears extending the framework with the concept of <strong><code>Terminable</code></strong> channel. After all, closing a channel in coroutines is a matter of sending a special token to it, allowing stop the iteration as soon as this token is received.
</blockquote>

<p>[<a href="https://github.com/tassiLuca/direct-style-experiments/blob/master/commons/src/main/scala/io/github/tassiLuca/dse/pimping/TerminableChannel.scala">The full implementation can be found in <code>commons</code> submodule, <code>pimping</code> package</a>.]</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A token to be sent to a channel to signal that it has been terminated. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">case</span> <span style="color:#8839ef">object</span> <span style="color:#df8e1d">Terminated</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">type</span> <span style="color:#d20f39">Terminated</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">Terminated</span><span style="color:#04a5e5;font-weight:bold">.</span><span style="color:#8839ef">type</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d20f39">/**</span> <span style="color:#d20f39">A</span> <span style="color:#d20f39">union</span> <span style="color:#8839ef">type</span> <span style="color:#d20f39">of</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]]</span> and <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Terminated</span><span style="color:#04a5e5;font-weight:bold">]].</span> <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">type</span> <span style="color:#d20f39">Terminable</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> T <span style="color:#04a5e5;font-weight:bold">|</span> <span style="color:#df8e1d">Terminated</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** Exception being raised by [[TerminableChannel.send()]] on terminated [[TerminableChannel]]. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">class</span> <span style="color:#df8e1d">ChannelTerminatedException</span> <span style="color:#8839ef">extends</span> <span style="color:#df8e1d">Exception</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A [[Channel]] that can be terminated, signalling no more items will be sent,
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  * still allowing to consumer to read pending values.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  * Trying to `send` values after its termination arise a [[ChannelTerminatedException]].
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  * When one consumer reads the [[Terminated]] token, the channel is closed. Any subsequent
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  * read will return `Left(Channel.Closed`.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">  */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#df8e1d">extends</span> <span style="color:#df8e1d">Channel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Terminable</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]]</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">def</span> <span style="color:#d20f39">terminate</span><span style="color:#04a5e5;font-weight:bold">()(</span><span style="color:#d20f39">using</span> <span style="color:#d20f39">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#d20f39">:</span> <span style="color:#d20f39">Unit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">object</span> <span style="color:#df8e1d">TerminableChannel</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">/**</span> <span style="color:#d20f39">Creates</span> <span style="color:#d20f39">a</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">]]</span> backed to <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">SyncChannel</span><span style="color:#04a5e5;font-weight:bold">]].</span> <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> ofSync<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">TerminableChannelImpl</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">SyncChannel</span><span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** Creates a [[TerminableChannel]] backed to [[BufferedChannel]]. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> ofBuffered<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">TerminableChannelImpl</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">BufferedChannel</span><span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** Creates a [[TerminableChannel]] backed to an [[UnboundedChannel]]. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> ofUnbounded<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">TerminableChannelImpl</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">UnboundedChannel</span><span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">private</span> <span style="color:#8839ef">class</span> <span style="color:#df8e1d">TerminableChannelImpl</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">](</span>c<span style="color:#8839ef">:</span> <span style="color:#d20f39">Channel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Terminable</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]])</span> <span style="color:#8839ef">extends</span> <span style="color:#df8e1d">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">opaque</span> <span style="color:#8839ef">type</span> <span style="color:#d20f39">Res</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Channel.Closed</span>, <span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">private</span> <span style="color:#8839ef">var</span> <span style="color:#df8e1d">_terminated</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Boolean</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#fe640b">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">override</span> <span style="color:#8839ef">val</span> readSource<span style="color:#8839ef">:</span> <span style="color:#d20f39">Async.Source</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Res</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Terminable</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]]]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>      c<span style="color:#04a5e5;font-weight:bold">.</span>readSource<span style="color:#04a5e5;font-weight:bold">.</span>transformValuesWith <span style="color:#04a5e5;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">case</span> <span style="color:#df8e1d">Right</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Terminated</span><span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#8839ef">=&gt;</span> c<span style="color:#04a5e5;font-weight:bold">.</span>close<span style="color:#04a5e5;font-weight:bold">();</span> <span style="color:#df8e1d">Left</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Channel</span><span style="color:#04a5e5;font-weight:bold">.</span><span style="color:#df8e1d">Closed</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">case</span> v <span style="color:#8839ef">@</span> <span style="color:#8839ef">_</span> <span style="color:#8839ef">=&gt;</span> v
</span></span><span style="display:flex;"><span>      <span style="color:#04a5e5;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> sendSource<span style="color:#04a5e5;font-weight:bold">(</span>x<span style="color:#8839ef">:</span> <span style="color:#d20f39">Terminable</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">])</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Async.Source</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Res</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>      synchronized<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d20f39">if</span> <span style="color:#8839ef">_</span><span style="color:#d20f39">terminated</span> <span style="color:#d20f39">then</span> <span style="color:#d20f39">throw</span> <span style="color:#d20f39">ChannelTerminatedException</span><span style="color:#04a5e5;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d20f39">else</span> <span style="color:#d20f39">if</span> <span style="color:#d20f39">x</span> <span style="color:#04a5e5;font-weight:bold">=</span><span style="color:#8839ef">=</span> <span style="color:#df8e1d">Terminated</span> then <span style="color:#df8e1d">_terminated</span> <span style="color:#8839ef">=</span> <span style="color:#fe640b">true</span>
</span></span><span style="display:flex;"><span>      c<span style="color:#04a5e5;font-weight:bold">.</span>sendSource<span style="color:#04a5e5;font-weight:bold">(</span>x<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> close<span style="color:#04a5e5;font-weight:bold">()</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span> c<span style="color:#04a5e5;font-weight:bold">.</span>close<span style="color:#04a5e5;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> terminate<span style="color:#04a5e5;font-weight:bold">()(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">try</span> send<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Terminated</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#9ca0b0;font-style:italic">// It happens only at the close of the channel due to the call (inside Gears library) of
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>      <span style="color:#9ca0b0;font-style:italic">// a CellBuf.dequeue(channels.scala:239) which is empty!
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>      <span style="color:#8839ef">catch</span> <span style="color:#8839ef">case</span> <span style="color:#8839ef">_:</span> <span style="color:#d20f39">NoSuchElementException</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#04a5e5;font-weight:bold">()</span> <span style="color:#9ca0b0;font-style:italic">// e.printStackTrace()
</span></span></span></code></pre></div><p>Now, thanks to this extension, also in Scala Gears is possible to write:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">val</span> channel <span style="color:#8839ef">=</span> <span style="color:#df8e1d">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">.</span>ofUnbounded<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Int</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#df8e1d">Future</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">0</span> <span style="color:#d20f39">until</span> <span style="color:#d20f39">10</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#d20f39">.foreach</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">channel.send</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span><span style="color:#04a5e5;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">channel.terminate</span><span style="color:#04a5e5;font-weight:bold">()</span> <span style="color:#9ca0b0;font-style:italic">// we&#39;re done sending
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>channel<span style="color:#04a5e5;font-weight:bold">.</span>foreach<span style="color:#04a5e5;font-weight:bold">(</span>println<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span><span style="color:#04a5e5;font-weight:bold">))</span> <span style="color:#9ca0b0;font-style:italic">// blocks until channel is closed
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>println<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">&#34;Done!&#34;</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span></code></pre></div><p>[<a href="https://github.com/tassiLuca/direct-style-experiments/blob/master/commons/src/test/scala/io/github/tassiLuca/dse/pimping/TerminableChannelTest.scala">Other tests can be found in <code>TerminableChannelTest</code></a>.]</p>
<p>On top of this new abstraction is possible to implement, for example, the <code>foreach</code> and <code>toSeq</code> methods, which can be useful to wait for all the items sent over the channel.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">object</span> <span style="color:#df8e1d">TerminableChannelOps</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">extension</span> <span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T:</span> <span style="color:#d20f39">ClassTag</span><span style="color:#04a5e5;font-weight:bold">](</span>c<span style="color:#8839ef">:</span> <span style="color:#d20f39">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Blocking consume channel items, executing the given function [[f]] for each element. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1e66f5;font-weight:bold">@tailrec</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> foreach<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">U</span><span style="color:#04a5e5;font-weight:bold">](</span>f<span style="color:#8839ef">:</span> <span style="color:#d20f39">T</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> U<span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span> c<span style="color:#04a5e5;font-weight:bold">.</span>read<span style="color:#04a5e5;font-weight:bold">()</span> <span style="color:#8839ef">match</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">case</span> <span style="color:#df8e1d">Left</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Channel</span><span style="color:#04a5e5;font-weight:bold">.</span><span style="color:#df8e1d">Closed</span><span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#8839ef">=&gt;</span> <span style="color:#04a5e5;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">case</span> <span style="color:#df8e1d">Right</span><span style="color:#04a5e5;font-weight:bold">(</span>value<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#8839ef">=&gt;</span>
</span></span><span style="display:flex;"><span>        value <span style="color:#8839ef">match</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">case</span> <span style="color:#df8e1d">Terminated</span> <span style="color:#8839ef">=&gt;</span> <span style="color:#04a5e5;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8839ef">case</span> v<span style="color:#8839ef">:</span> <span style="color:#d20f39">T</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> f<span style="color:#04a5e5;font-weight:bold">(</span>v<span style="color:#04a5e5;font-weight:bold">);</span> foreach<span style="color:#04a5e5;font-weight:bold">(</span>f<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** @return a [[Seq]] containing channel items, after having them read.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">      * This is a blocking operation! */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> toSeq<span style="color:#04a5e5;font-weight:bold">(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">var</span> results <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]()</span>
</span></span><span style="display:flex;"><span>      c<span style="color:#04a5e5;font-weight:bold">.</span>foreach<span style="color:#04a5e5;font-weight:bold">(</span>t <span style="color:#8839ef">=&gt;</span> results <span style="color:#8839ef">=</span> results <span style="color:#8839ef">:</span><span style="color:#d20f39">+</span> <span style="color:#d20f39">t</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      results
</span></span></code></pre></div><p>Three types of channels exist:</p>
<ul>
<li><strong>Synchronous Channels</strong>: links a <code>read</code> request with a <code>send</code> within a <em>rendezvous</em>
<figure><img src="../../res/img/sync-channel.svg"
      alt="synchronous channel">
  </figure>

<ul>
<li><code>send</code> (<code>read</code>) suspend the process until a consumer <code>read</code> (<code>send</code>) the value;</li>
<li>in Kotlin they are called <strong>Rendezvous Channels</strong>.</li>
</ul>
</li>
<li><strong>Buffered Channels</strong>: a version of a channel with an internal buffer of fixed size
<figure><img src="../../res/img/buffered-channel.svg"
      alt="buffered channel">
  </figure>

<ul>
<li><code>send</code> suspend the producer process if it is full; otherwise, it appends the value to the buffer, returning immediately;</li>
<li><code>read</code> suspend if the channel is empty, waiting for a new value.</li>
</ul>
</li>
<li><strong>Unbounded Channels</strong>: a version of a channel with an unbounded buffer
<figure><img src="../../res/img/unbounded-channel.svg"
      alt="unbounded channel">
  </figure>

<ul>
<li>if the programs run out of memory you can get an out-of-memory exception!</li>
<li>in Kotlin they are called <strong>Unlimited Channel</strong>.</li>
</ul>
</li>
</ul>
<p>Kotlin offers also a fourth type: the <strong>Conflated Channel</strong>, where every new element sent to it overwrites the previously sent one, <em>never blocking</em>, so that the receiver gets always the latest element.</p>
<p>Concerning channel behavior, it is important to note that:</p>
<blockquote class="book-hint info">
  <ol>
<li>Multiple producers can send data to the channel, as well as multiple consumers can read them, <strong>but each element is handled only <em>once</em>, by <em>one</em> of them</strong>, i.e. consumers <strong>compete</strong> with each other for sent values;</li>
<li>Once the element is handled, it is immediately removed from the channel;
<ul>
<li>Channels are fair: <code>send</code> and <code>read</code> operations to channels are fair w.r.t. the order of their invocations from multiple threads (they are served in first-in first-out order).</li>
</ul>
</li>
</ol>

</blockquote>

<h2 id="analyzer-example">
  Analyzer example
  <a class="anchor" href="#analyzer-example">#</a>
</h2>
<p>To show channels in action an example has been prepared:</p>
<blockquote>
<p><strong>Idea</strong>: we want to realize a little asynchronous library allowing clients to collect the common statistics about repositories (issues, stars, last release) and contributors of a given GitHub organization.</p>
</blockquote>
<p>The final result is a GUI application that, given an organization name, starts the analysis of all its repositories,
listing their information along with all their contributors as soon as they are computed. Moreover, the application allows the user to cancel the current computation at any point in time.</p>
<p><img src="../../res/img/analyzer-e2e.png" alt="expected result" /></p>
<p>[This example has been inspired by <a href="https://kotlinlang.org/docs/coroutines-and-channels.html">this</a> tutorial.]</p>
<hr>
<p>To start the application:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>./gradlew analyzer-&lt;direct | direct-kt | monadic&gt;:run
</span></span></code></pre></div><blockquote class="book-hint warning">
  <p>In order to run the application you need to place inside the <code>analyzer-commons</code> directory a <code>.env</code> file containing <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens">your personal GitHub access token</a>, like:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-env" data-lang="env"><span style="display:flex;"><span><span style="color:#dc8a78">GH_TOKEN</span><span style="color:#04a5e5;font-weight:bold">=</span>....
</span></span></code></pre></div><p>or having set an environment variable named <code>GH_TOKEN</code>.</p>

</blockquote>

<hr>
<p>The example is structured in two different packages: <code>lib</code> and <code>client</code>. The former contains the logic of the library, while the latter contains the application (client code).
As usual, it has been implemented using monadic <code>Future</code>s, as well as using Scala Gears and Kotlin Coroutines.</p>
<h3 id="future-monadic-version">
  Future monadic version
  <a class="anchor" href="#future-monadic-version">#</a>
</h3>
<p>[<a href="https://github.com/tassiLuca/direct-style-experiments/tree/master/blog-ws-monadic/src/main/scala/io/github/tassiLuca/dse/blog">The sources are available inside the <code>analyzer-monadic</code> submodule</a>.]</p>
<p>The entry point of the library is the <code>Analyzer</code> interface which takes in input the organization name and a function through which is possible to react to results while they are computed.</p>
<p>Since we want to achieve cancellation, the monadic version leverages Monix <code>Task</code>, which is returned by the <code>analyze</code> method wrapped in an <code>EitherT</code> monad transformer to allow handling errors functionally.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A generic analyzer of organization/group/workspace repositories. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">Analyzer</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">/**</span> <span style="color:#d20f39">@return</span> <span style="color:#d20f39">a</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">EitherT</span><span style="color:#04a5e5;font-weight:bold">]]</span> encapsulating a <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">]]</span> that performs the analysis of the
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">organizationName</span><span style="color:#04a5e5;font-weight:bold">]]</span>&#39;s repositories<span style="color:#04a5e5;font-weight:bold">,</span> providing the results incrementally to the
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">updateResults</span><span style="color:#04a5e5;font-weight:bold">]]</span> function<span style="color:#04a5e5;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> analyze<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)(</span>
</span></span><span style="display:flex;"><span>      updateResult<span style="color:#8839ef">:</span> <span style="color:#d20f39">RepositoryReport</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">EitherT</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Task</span>, <span style="color:#d20f39">String</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span></code></pre></div><p>To retrieve data from GitHub, a <code>RepositoryService</code> interface has been created, following the same pattern:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A service exposing functions to retrieve data from a central hosting repository service. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">RepositoryService</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">/**</span> <span style="color:#d20f39">@return</span> <span style="color:#d20f39">a</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">EitherT</span><span style="color:#04a5e5;font-weight:bold">]]</span> encapsulating a <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">]]</span> which get all the repositories
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span>         owned by <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">organizationName</span><span style="color:#04a5e5;font-weight:bold">]].</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> repositoriesOf<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">EitherT</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Task</span>, <span style="color:#d20f39">String</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Repository</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** @return a [[EitherT]] encapsulating a [[Task]] which get all the contributors
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    *         of [[repositoryName]] owned by [[organizationName]].
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> contributorsOf<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">,</span> repositoryName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">EitherT</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Task</span>, <span style="color:#d20f39">String</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Contribution</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** @return a [[EitherT]] encapsulating a [[Task]] which get the last release
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    *         of [[repositoryName]] owned by [[organizationName]].
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> lastReleaseOf<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">,</span> repositoryName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">EitherT</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Task</span>, <span style="color:#d20f39">String</span>, <span style="color:#d20f39">Release</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span></code></pre></div><p>The implementation of the <code>Analyzer</code> is shown in the following code snippet and performs the following steps:</p>
<ol>
<li>first, the list of repositories is retrieved;</li>
<li>if no error occurs, the analysis of each repository is performed concurrently, thanks to the <code>parTraverse</code> operator;</li>
<li>the analysis of each repository consists of retrieving the contributors and the last release of the repository and then updating the result through the <code>updateResult</code> function. Since both the contributors and last release retrieval are independent of each other, they are performed concurrently, thanks to <code>Task.parZip2</code>.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> analyze<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)(</span>
</span></span><span style="display:flex;"><span>    updateResult<span style="color:#8839ef">:</span> <span style="color:#d20f39">RepositoryReport</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">EitherT</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Task</span>, <span style="color:#d20f39">String</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">for</span>
</span></span><span style="display:flex;"><span>    repositories <span style="color:#8839ef">&lt;-</span> repositoryService<span style="color:#04a5e5;font-weight:bold">.</span>repositoriesOf<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    reports <span style="color:#8839ef">&lt;-</span> repositories<span style="color:#04a5e5;font-weight:bold">.</span>parTraverse<span style="color:#04a5e5;font-weight:bold">(</span>r <span style="color:#8839ef">=&gt;</span> <span style="color:#df8e1d">EitherT</span><span style="color:#04a5e5;font-weight:bold">.</span>right<span style="color:#04a5e5;font-weight:bold">(</span>r<span style="color:#04a5e5;font-weight:bold">.</span>performAnalysis<span style="color:#04a5e5;font-weight:bold">(</span>updateResult<span style="color:#04a5e5;font-weight:bold">)))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">yield</span> reports
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>extension <span style="color:#04a5e5;font-weight:bold">(</span>r<span style="color:#8839ef">:</span> <span style="color:#d20f39">Repository</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">private</span> <span style="color:#8839ef">def</span> performAnalysis<span style="color:#04a5e5;font-weight:bold">(</span>updateResult<span style="color:#8839ef">:</span> <span style="color:#d20f39">RepositoryReport</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> contributorsTask <span style="color:#8839ef">=</span> repositoryService<span style="color:#04a5e5;font-weight:bold">.</span>contributorsOf<span style="color:#04a5e5;font-weight:bold">(</span>r<span style="color:#04a5e5;font-weight:bold">.</span>organization<span style="color:#04a5e5;font-weight:bold">,</span> r<span style="color:#04a5e5;font-weight:bold">.</span>name<span style="color:#04a5e5;font-weight:bold">).</span>value
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> releaseTask <span style="color:#8839ef">=</span> repositoryService<span style="color:#04a5e5;font-weight:bold">.</span>lastReleaseOf<span style="color:#04a5e5;font-weight:bold">(</span>r<span style="color:#04a5e5;font-weight:bold">.</span>organization<span style="color:#04a5e5;font-weight:bold">,</span> r<span style="color:#04a5e5;font-weight:bold">.</span>name<span style="color:#04a5e5;font-weight:bold">).</span>value
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">for</span>
</span></span><span style="display:flex;"><span>      result <span style="color:#8839ef">&lt;-</span> <span style="color:#df8e1d">Task</span><span style="color:#04a5e5;font-weight:bold">.</span>parZip2<span style="color:#04a5e5;font-weight:bold">(</span>contributorsTask<span style="color:#04a5e5;font-weight:bold">,</span> releaseTask<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      report <span style="color:#8839ef">=</span> <span style="color:#df8e1d">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">(</span>r<span style="color:#04a5e5;font-weight:bold">.</span>name<span style="color:#04a5e5;font-weight:bold">,</span> r<span style="color:#04a5e5;font-weight:bold">.</span>issues<span style="color:#04a5e5;font-weight:bold">,</span> r<span style="color:#04a5e5;font-weight:bold">.</span>stars<span style="color:#04a5e5;font-weight:bold">,</span> result<span style="color:#04a5e5;font-weight:bold">.</span>_1<span style="color:#04a5e5;font-weight:bold">.</span>getOrElse<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Seq</span><span style="color:#04a5e5;font-weight:bold">.</span>empty<span style="color:#04a5e5;font-weight:bold">),</span> result<span style="color:#04a5e5;font-weight:bold">.</span>_2<span style="color:#04a5e5;font-weight:bold">.</span>toOption<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">_</span> <span style="color:#8839ef">&lt;-</span> <span style="color:#df8e1d">Task</span><span style="color:#04a5e5;font-weight:bold">(</span>updateResult<span style="color:#04a5e5;font-weight:bold">(</span>report<span style="color:#04a5e5;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">yield</span> report
</span></span></code></pre></div><p>Client-side, when a new session is requested, the <code>Analyzer</code> is used to start the computation, during which the single reports are aggregated and the UI is updated.
Whenever desired, the current computation can be stopped by canceling the Monix <code>CancelableFuture</code> returned by the <code>runToFuture</code> method, through which the returned Task from the <code>Analyzer</code> is started.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">class</span> <span style="color:#df8e1d">MonadicAppController</span> <span style="color:#8839ef">extends</span> <span style="color:#df8e1d">AppController</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">import</span> <span style="color:#d20f39">monix.execution.Scheduler.Implicits.global</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">private</span> <span style="color:#8839ef">val</span> view <span style="color:#8839ef">=</span> <span style="color:#df8e1d">AnalyzerView</span><span style="color:#04a5e5;font-weight:bold">.</span>gui<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">this</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">private</span> <span style="color:#8839ef">val</span> analyzer <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Analyzer</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">RepositoryService</span><span style="color:#04a5e5;font-weight:bold">.</span>ofGitHub<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">private</span> <span style="color:#8839ef">var</span> currentComputation<span style="color:#8839ef">:</span> <span style="color:#d20f39">Option</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">CancelableFuture</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  view<span style="color:#04a5e5;font-weight:bold">.</span>run<span style="color:#04a5e5;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> runSession<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">var</span> organizationReport<span style="color:#8839ef">:</span> <span style="color:#d20f39">OrganizationReport</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Map</span><span style="color:#04a5e5;font-weight:bold">(),</span> <span style="color:#df8e1d">Set</span><span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> f <span style="color:#8839ef">=</span> analyzer<span style="color:#04a5e5;font-weight:bold">.</span>analyze<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#04a5e5;font-weight:bold">{</span> report <span style="color:#8839ef">=&gt;</span>
</span></span><span style="display:flex;"><span>      organizationReport <span style="color:#8839ef">=</span> organizationReport<span style="color:#04a5e5;font-weight:bold">.</span>mergeWith<span style="color:#04a5e5;font-weight:bold">(</span>report<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      view<span style="color:#04a5e5;font-weight:bold">.</span>update<span style="color:#04a5e5;font-weight:bold">(</span>organizationReport<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">}.</span>value<span style="color:#04a5e5;font-weight:bold">.</span>runToFuture<span style="color:#04a5e5;font-weight:bold">.</span>map <span style="color:#04a5e5;font-weight:bold">{</span> <span style="color:#8839ef">case</span> <span style="color:#df8e1d">Left</span><span style="color:#04a5e5;font-weight:bold">(</span>value<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#8839ef">=&gt;</span> view<span style="color:#04a5e5;font-weight:bold">.</span>error<span style="color:#04a5e5;font-weight:bold">(</span>value<span style="color:#04a5e5;font-weight:bold">);</span> <span style="color:#8839ef">case</span> <span style="color:#df8e1d">Right</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span><span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#8839ef">=&gt;</span> view<span style="color:#04a5e5;font-weight:bold">.</span>endComputation<span style="color:#04a5e5;font-weight:bold">()</span> <span style="color:#04a5e5;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    currentComputation <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Some</span><span style="color:#04a5e5;font-weight:bold">(</span>f<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> stopSession<span style="color:#04a5e5;font-weight:bold">()</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span> currentComputation foreach <span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span><span style="color:#04a5e5;font-weight:bold">.</span>cancel<span style="color:#04a5e5;font-weight:bold">())</span>
</span></span></code></pre></div><h3 id="scala-gears-version">
  Scala Gears version
  <a class="anchor" href="#scala-gears-version">#</a>
</h3>
<p>[<a href="https://github.com/tassiLuca/direct-style-experiments/tree/master/analyzer-direct/src/main/scala/io/github/tassiLuca/analyzer">The sources are available inside the <code>analyzer-direct</code> submodule</a>.]</p>
<p>The interfaces of the Direct Style with Gears differ from the monadic one by their return type, which is a simpler <code>Either</code> data type, and by the fact they are <strong>suspendable functions</strong>, hence they require an Async context to be executed.
This is the first important difference: the <code>analyze</code> method, differently from the monadic version, doesn&rsquo;t return immediately the control; instead, it suspends the execution of the client until the result is available (though offering the opportunity to react to each update).
This obeys the principle of <strong>explicit asynchrony</strong>: if the client wants to perform this operation asynchronously, it has to opt in explicitly, using a <code>Future</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A generic analyzer of organization/group/workspace repositories. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">Analyzer</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">/**</span> <span style="color:#d20f39">Performs</span> <span style="color:#d20f39">a</span> <span style="color:#d20f39">**suspending**</span> <span style="color:#d20f39">analysis</span> <span style="color:#d20f39">of</span> <span style="color:#d20f39">the</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">organizationName</span><span style="color:#04a5e5;font-weight:bold">]]</span>&#39;s repositories<span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span> providing the results incrementally to the <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">updateResults</span><span style="color:#04a5e5;font-weight:bold">]]</span> function<span style="color:#04a5e5;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span> <span style="color:#1e66f5;font-weight:bold">@return</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Right</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">with</span> the overall results of the analysis or <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Left</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">with</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span>         an error message in <span style="color:#8839ef">case</span> of failure<span style="color:#04a5e5;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> analyze<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)(</span>
</span></span><span style="display:flex;"><span>      updateResults<span style="color:#8839ef">:</span> <span style="color:#d20f39">RepositoryReport</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">AsyncOperations</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** A service exposing functions to retrieve data from a central hosting repository service. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">RepositoryService</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">/**</span> <span style="color:#d20f39">@return</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Right</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">with</span> the <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">]]</span>uence of <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Repository</span><span style="color:#04a5e5;font-weight:bold">]]</span> owned by the given
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span>         <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">organizationName</span><span style="color:#04a5e5;font-weight:bold">]]</span> or a <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Left</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">with</span> a explanatory message in <span style="color:#8839ef">case</span> of errors<span style="color:#04a5e5;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> repositoriesOf<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Repository</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** @return [[Right]] with the [[Seq]]uence of [[Contribution]] for the given 
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    *       [[repositoryName]] owned by the given [[organizationName]] or a [[Left]] with an 
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    *       explanatory message in case of errors.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> contributorsOf<span style="color:#04a5e5;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>    repositoryName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Contribution</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** @return a [[Right]] with the last [[Release]] of the given [[repositoryName]] owned 
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    *         by [[organizationName]] if it exists, or a [[Left]] with a explanatory message
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    *         in case of errors.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> lastReleaseOf<span style="color:#04a5e5;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>    repositoryName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Release</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span></code></pre></div><p>The implementation of the <code>Analyzer</code> leverages Channels to perform the concurrent analysis of the repositories:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> analyze<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)(</span>
</span></span><span style="display:flex;"><span>    updateResults<span style="color:#8839ef">:</span> <span style="color:#d20f39">RepositoryReport</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">AsyncOperations</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">=</span> either<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">val</span> <span style="color:#d20f39">reposInfo</span> <span style="color:#04a5e5;font-weight:bold">=</span> repositoryService<span style="color:#04a5e5;font-weight:bold">.</span>repositoriesOf<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#04a5e5;font-weight:bold">).?</span> <span style="color:#9ca0b0;font-style:italic">// 1
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    <span style="color:#04a5e5;font-weight:bold">.</span>map<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span><span style="color:#04a5e5;font-weight:bold">.</span>performAnalysis<span style="color:#04a5e5;font-weight:bold">.</span>run<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#9ca0b0;font-style:italic">// 2
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>  <span style="color:#8839ef">val</span> collector <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Collector</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">](</span>reposInfo<span style="color:#04a5e5;font-weight:bold">.</span>toList<span style="color:#04a5e5;font-weight:bold">*)</span> <span style="color:#9ca0b0;font-style:italic">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>  reposInfo<span style="color:#04a5e5;font-weight:bold">.</span>foreach<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span> <span style="color:#8839ef">=&gt;</span> 
</span></span><span style="display:flex;"><span>    updateResults<span style="color:#04a5e5;font-weight:bold">(</span>collector<span style="color:#04a5e5;font-weight:bold">.</span>results<span style="color:#04a5e5;font-weight:bold">.</span>read<span style="color:#04a5e5;font-weight:bold">().</span>asTry<span style="color:#04a5e5;font-weight:bold">.?.</span>awaitResult<span style="color:#04a5e5;font-weight:bold">.?)</span> <span style="color:#9ca0b0;font-style:italic">// 4
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>  <span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  reposInfo<span style="color:#04a5e5;font-weight:bold">.</span>awaitAll <span style="color:#9ca0b0;font-style:italic">// 5
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>
</span></span><span style="display:flex;"><span>extension <span style="color:#04a5e5;font-weight:bold">(</span>r<span style="color:#8839ef">:</span> <span style="color:#d20f39">Repository</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">protected</span> <span style="color:#8839ef">def</span> performAnalysis<span style="color:#04a5e5;font-weight:bold">(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Task</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">val</span> <span style="color:#d20f39">contributions</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">Future</span><span style="color:#8839ef">:</span> <span style="color:#9ca0b0;font-style:italic">// concurrent!
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>      repositoryService<span style="color:#04a5e5;font-weight:bold">.</span>contributorsOf<span style="color:#04a5e5;font-weight:bold">(</span>r<span style="color:#04a5e5;font-weight:bold">.</span>organization<span style="color:#04a5e5;font-weight:bold">,</span> r<span style="color:#04a5e5;font-weight:bold">.</span>name<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> release <span style="color:#8839ef">=</span> repositoryService<span style="color:#04a5e5;font-weight:bold">.</span>lastReleaseOf<span style="color:#04a5e5;font-weight:bold">(</span>r<span style="color:#04a5e5;font-weight:bold">.</span>organization<span style="color:#04a5e5;font-weight:bold">,</span> r<span style="color:#04a5e5;font-weight:bold">.</span>name<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#df8e1d">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">(</span>r<span style="color:#04a5e5;font-weight:bold">.</span>name<span style="color:#04a5e5;font-weight:bold">,</span> r<span style="color:#04a5e5;font-weight:bold">.</span>issues<span style="color:#04a5e5;font-weight:bold">,</span> r<span style="color:#04a5e5;font-weight:bold">.</span>stars<span style="color:#04a5e5;font-weight:bold">,</span> contributions<span style="color:#04a5e5;font-weight:bold">.</span>await<span style="color:#04a5e5;font-weight:bold">.</span>getOrElse<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Seq</span><span style="color:#04a5e5;font-weight:bold">()),</span> release<span style="color:#04a5e5;font-weight:bold">.</span>toOption<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span></code></pre></div><ol>
<li>first, we get all the repositories of the requested organization</li>
<li>for each of them, the contributors and the last release are retrieved concurrently, starting a <code>Future</code></li>
<li><code>Future</code> results are gathered inside a <strong><code>Collector</code></strong> allowing to collect a list of futures into a channel of futures, <strong>arriving as they finish</strong>.
<ul>
<li>the retrieval of the contributors and the last release are performed in parallel</li>
</ul>
</li>
<li>read results from the channel as they come, calling the <code>updateResult</code> reaction function.</li>
<li>Overall results are returned to the client.</li>
</ol>
<p>Although it works, the proposed solution suffers from a performance issue when the organization we want to analyze has a large number of repositories.
Indeed, the GitHub API, like many ReSTful APIs, implements <em>pagination</em>: if the response includes many results, they are paginated, returning a subset of them; it is the responsibility of the client to request more data (pages).
Until now, the <code>RepositoryService</code> has been implemented to return the whole results in one shot, leading to suspension until all pages are retrieved.
It would be desirable, instead, to start performing the analysis as soon as one page is obtained from the API.</p>
<p>To do so, the interface of the <code>RepositoryService</code> has been extended with new methods, <code>incremental***</code>, returning a <code>TerminableChannel</code> of results:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">RepositoryService</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">/**</span> <span style="color:#d20f39">@return</span> <span style="color:#d20f39">a</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Terminable</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">ReadableChannel</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">with</span> the <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Repository</span><span style="color:#04a5e5;font-weight:bold">]]</span> owned by the given
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span>         <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">organizationName</span><span style="color:#04a5e5;font-weight:bold">]],</span> wrapped inside a <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">for</span> errors management<span style="color:#04a5e5;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> incrementalRepositoriesOf<span style="color:#04a5e5;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Repository</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** @return a [[Terminable]] [[ReadableChannel]] with the [[Contribution]] made by users to the
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    *         given [[repositoryName]] owned by [[organizationName]], wrapped inside a [[Either]].
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> incrementalContributorsOf<span style="color:#04a5e5;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>      organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      repositoryName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Contribution</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">// ...
</span></span></span></code></pre></div><p>Then, the implementation of the <code>analyze</code> method becomes:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> analyze<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)(</span>
</span></span><span style="display:flex;"><span>    updateResults<span style="color:#8839ef">:</span> <span style="color:#d20f39">RepositoryReport</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">AsyncOperations</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">=</span> either<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">val</span> <span style="color:#d20f39">reposInfo</span> <span style="color:#04a5e5;font-weight:bold">=</span> repositoryService<span style="color:#04a5e5;font-weight:bold">.</span>incrementalRepositoriesOf<span style="color:#04a5e5;font-weight:bold">(</span>organizationName<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#9ca0b0;font-style:italic">// 1
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>  <span style="color:#8839ef">var</span> futures <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Seq</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">RepositoryReport</span><span style="color:#04a5e5;font-weight:bold">]]()</span>
</span></span><span style="display:flex;"><span>  reposInfo<span style="color:#04a5e5;font-weight:bold">.</span>foreach <span style="color:#04a5e5;font-weight:bold">{</span> repository <span style="color:#8839ef">=&gt;</span> <span style="color:#9ca0b0;font-style:italic">// 2
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    futures <span style="color:#8839ef">=</span> futures <span style="color:#8839ef">:</span><span style="color:#d20f39">+</span> <span style="color:#d20f39">Future:</span> <span style="color:#9ca0b0;font-style:italic">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>      <span style="color:#8839ef">val</span> report <span style="color:#8839ef">=</span> repository<span style="color:#04a5e5;font-weight:bold">.?.</span>performAnalysis<span style="color:#04a5e5;font-weight:bold">.</span>run<span style="color:#04a5e5;font-weight:bold">.</span>awaitResult<span style="color:#04a5e5;font-weight:bold">.?</span>
</span></span><span style="display:flex;"><span>      updateResults<span style="color:#04a5e5;font-weight:bold">(</span>report<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      report
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  futures<span style="color:#04a5e5;font-weight:bold">.</span>awaitAllOrCancel
</span></span></code></pre></div><ol>
<li>we get the channel of repositories from the repository service;</li>
<li>the <code>foreach</code> method of <code>TerminableChannel</code> is used to iterate over all the repositories sent over the channel as soon as they are retrieved by the service. This is a blocking operation, i.e. it suspends until all the repositories are retrieved;</li>
<li>we start the analysis in a separate <code>Future</code> (i.e. thread): this allows you to start the analysis as soon as a repository is fetched by the channel, preventing starting the analysis of the next repository only when the previous one is finished;</li>
<li>once all the repositories are retrieved, i.e. the <code>foreach</code> terminates, we wait for the completion of all the started <code>Future</code>s. Indeed, when the <code>foreach</code> terminates, we have the guarantee that all started futures have been started, but not yet completed!</li>
</ol>
<h3 id="kotlin-coroutines-version">
  Kotlin Coroutines version
  <a class="anchor" href="#kotlin-coroutines-version">#</a>
</h3>
<p>[<a href="https://github.com/tassiLuca/direct-style-experiments/tree/master/analyzer-direct-kt/src/main/kotlin/io/github/tassiLuca/analyzer">The sources are available inside the <code>analyzer-direct-kt</code> submodule</a>.]</p>
<p>The analyzer interface reflects the Scala Gears one: a <code>Result</code> is used in place of <code>Either</code>, and the suspendable function <code>udateResults</code> is marked with the <code>suspend</code> keyword in place of the <code>using Async</code> context.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">interface</span> <span style="color:#df8e1d">Analyzer</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">analyze</span>(
</span></span><span style="display:flex;"><span>        organizationName: String,
</span></span><span style="display:flex;"><span>        updateResults: <span style="color:#8839ef">suspend</span> (RepositoryReport) <span style="color:#04a5e5;font-weight:bold">-&gt;</span> Unit = { _ <span style="color:#04a5e5;font-weight:bold">-&gt;</span> },
</span></span><span style="display:flex;"><span>    ): Result&lt;Set&lt;RepositoryReport&gt;&gt;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Its channel-based implementation, despite syntactic differences, is also very similar to that of Scala Gears, at least conceptually:</p>
<ol>
<li>we get all the repositories;</li>
<li>for each of them, an analysis is started to retrieve the contributors and the last release;
<ul>
<li>each analysis is started in a separate coroutine whose results are sent to a channel;</li>
<li>as usual, the contributors and the last release are retrieved concurrently, using the <code>async</code> coroutine builder;</li>
</ul>
</li>
<li>results are aggregated as they come from the channel.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">override</span> <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">analyze</span>(
</span></span><span style="display:flex;"><span>    organizationName: String,
</span></span><span style="display:flex;"><span>    updateResults: <span style="color:#8839ef">suspend</span> (RepositoryReport) <span style="color:#04a5e5;font-weight:bold">-&gt;</span> Unit,
</span></span><span style="display:flex;"><span>): Result&lt;Set&lt;RepositoryReport&gt;&gt; = coroutineScope {
</span></span><span style="display:flex;"><span>    runCatching {
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">val</span> <span style="color:#fe640b">repositories</span> = provider.repositoriesOf(organizationName).getOrThrow() <span style="color:#9ca0b0;font-style:italic">// 1
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>        <span style="color:#8839ef">val</span> <span style="color:#fe640b">resultsChannel</span> = analyzeAll(organizationName, repositories) <span style="color:#9ca0b0;font-style:italic">// 2
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>        collectResults(resultsChannel, repositories.size, updateResults) <span style="color:#9ca0b0;font-style:italic">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">private</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">CoroutineScope</span>.analyzeAll(organizationName: String, repositories: List&lt;Repository&gt;) =
</span></span><span style="display:flex;"><span>    Channel&lt;RepositoryReport&gt;().also {
</span></span><span style="display:flex;"><span>        repositories.map { r <span style="color:#04a5e5;font-weight:bold">-&gt;</span>
</span></span><span style="display:flex;"><span>            launch { <span style="color:#9ca0b0;font-style:italic">// a new coroutine for each repository is started
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>                <span style="color:#8839ef">val</span> <span style="color:#fe640b">contributors</span> = async { provider.contributorsOf(organizationName, r.name).getOrThrow() }
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">val</span> <span style="color:#fe640b">release</span> = provider.lastReleaseOf(organizationName, r.name).getOrThrow()
</span></span><span style="display:flex;"><span>                <span style="color:#8839ef">it</span>.send(RepositoryReport(r.name, r.issues, r.stars, contributors.await(), release))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">private</span> <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">collectResults</span>(
</span></span><span style="display:flex;"><span>    resultsChannel: Channel&lt;RepositoryReport&gt;,
</span></span><span style="display:flex;"><span>    expectedResults: Int,
</span></span><span style="display:flex;"><span>    updateResults: <span style="color:#8839ef">suspend</span> (RepositoryReport) <span style="color:#04a5e5;font-weight:bold">-&gt;</span> Unit,
</span></span><span style="display:flex;"><span>) = mutableSetOf&lt;RepositoryReport&gt;().apply {
</span></span><span style="display:flex;"><span>    repeat(expectedResults) {
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">val</span> <span style="color:#fe640b">report</span> = resultsChannel.receive()
</span></span><span style="display:flex;"><span>        add(report)
</span></span><span style="display:flex;"><span>        updateResults(report)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    resultsChannel.close()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Where, instead, Kotlin Coroutines shine is the implementation of the <code>RepositoryService</code> for supporting incremental retrieval of repositories and contributors.</p>
<p>Indeed, Kotlin has a built-in support for cold streams, called <strong><code>Flow</code></strong>. They are very similar (actually they have been inspired to) cold observable in reactive programming, and <strong>they are the perfect fit for functions that need to return a stream of asynchronously computed values</strong>.</p>
<p>The <code>RepositoryService</code> has been here extended with new methods, <code>flowing***</code>, returning a <code>Flow</code> of results:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">class</span> <span style="color:#df8e1d">GitHubRepositoryProvider</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">flowingRepositoriesOf</span>(organizationName: String): Flow&lt;List&lt;Repository&gt;&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">flowingContributorsOf</span>(organizationName: String, repositoryName: String): Flow&lt;List&lt;Contribution&gt;&gt;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As already mentioned, the <code>Flow</code> is a <strong>cold stream</strong>, meaning that it is <strong>not</strong> started until it is <strong><code>collect</code>ed</strong>. Once the <code>collect</code> method is called a new stream is created and data starts to &ldquo;flow&rdquo;.</p>
<p>They offer several useful operators for transforming and combining them functionally (not a complete list):</p>
<div class="book-columns flex flex-wrap">

  <div class="flex-even markdown-inner">
    <p><em>Intermediate flow operators</em>:</p>
<ul>
<li><code>filter</code>/<code>filterNot</code> to filter out unwanted values;</li>
<li><code>map</code> to transform the values;</li>
<li><code>transform</code> to implement more complex transformations (possibly involving suspending operations);</li>
<li><code>take</code> and its variant (e.g. <code>takeWhile</code>) to limit the number of values emitted;</li>
<li><code>onEach</code> to perform side-effects for each value emitted.</li>
</ul>
  </div>

  <div class="flex-even markdown-inner">
    <p><em>Terminal flow operators</em>:</p>
<ul>
<li>conversions to various collection types, like <code>toList</code>, <code>toSet</code>;</li>
<li><code>first</code>, <code>last</code>, <code>single</code> to retrieve the first, last or single value emitted;</li>
<li><code>reduce</code> to perform some kind of operation over all items, reducing them to a single one;</li>
<li><code>fold</code> to perform some kind of operation over all items, starting from an initial value, accumulating a result.</li>
</ul>
  </div>

  <div class="flex-even markdown-inner">
    <p><em>Flows combining operators</em>:</p>
<ul>
<li><code>merge</code> to combine multiple flows into a single one, emitting values from all of them;</li>
<li><code>zip</code> combines the corresponding values of two flows;</li>
<li><code>flatMapConcat</code> / <code>flatMapMerge</code> to transform each value into a flow and then concatenate/merge them.</li>
</ul>
  </div>

</div>

<p>Moreover, like in Rx:</p>
<ul>
<li>it is possible to control the context in which the flow is executed using the <code>flowOn</code> operator, which changes the context for all the steps above it (so it is typically used as the last step in a function);</li>
<li>some backpressure strategies are supported, which are used to handle the situation when the producer is emitting values faster than the consumer can process them. In Kotlin Coroutines, the backpressure is managed by the <code>buffer</code> (and its variant, like <code>conflated</code>, <code>sample</code>, <code>debounce</code>) operator, which allows to buffer a certain number of values before the consumer starts to process them.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">override</span> <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">analyze</span>(
</span></span><span style="display:flex;"><span>    organizationName: String,
</span></span><span style="display:flex;"><span>    updateResults: <span style="color:#8839ef">suspend</span> (RepositoryReport) <span style="color:#04a5e5;font-weight:bold">-&gt;</span> Unit,
</span></span><span style="display:flex;"><span>): Result&lt;Set&lt;RepositoryReport&gt;&gt; = coroutineScope {
</span></span><span style="display:flex;"><span>    runCatching {
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">val</span> <span style="color:#fe640b">reports</span> = provider.flowingRepositoriesOf(organizationName)
</span></span><span style="display:flex;"><span>            .flatMapConcat { analyzeAll(<span style="color:#8839ef">it</span>) }
</span></span><span style="display:flex;"><span>            .flowOn(<span style="color:#df8e1d">Dispatchers</span>.Default)
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">var</span> <span style="color:#fe640b">allReports</span> = emptySet&lt;RepositoryReport&gt;() 
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic">// until here just &#34;configuration&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>        reports.collect {
</span></span><span style="display:flex;"><span>            updateResults(<span style="color:#8839ef">it</span>)
</span></span><span style="display:flex;"><span>            allReports = allReports + <span style="color:#8839ef">it</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        allReports
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Concerning flows, an important thing to note is that they are just asynchronous generators that run some suspending code when you collect them. Thus, per se, they don&rsquo;t introduce new coroutines or concurrency mechanism.
To achieve concurrency, for example emitting values concurrently by multiple coroutines, is necessary to use a <code>channelFlow</code>, a pre-cooked way to inject a <code>coroutineContext</code> and a <code>Channel</code> through which is possible to pass the values to be emitted from a background coroutines back to the main control flow:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">fun</span> <span style="color:#1e66f5">analyzeAll</span>(repositories: List&lt;Repository&gt;): Flow&lt;RepositoryReport&gt; = channelFlow {
</span></span><span style="display:flex;"><span>    repositories.forEach { repository <span style="color:#04a5e5;font-weight:bold">-&gt;</span>
</span></span><span style="display:flex;"><span>        launch {
</span></span><span style="display:flex;"><span>            <span style="color:#8839ef">val</span> <span style="color:#fe640b">release</span> = async {
</span></span><span style="display:flex;"><span>               provider.lastReleaseOf(repository.organization, repository.name).getOrThrow()
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            provider.flowingContributorsOf(repository.organization, repository.name).toList().forEach {
</span></span><span style="display:flex;"><span>                <span style="color:#9ca0b0;font-style:italic">// emit this value
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>                send(RepositoryReport(repository.name, repository.issues, repository.stars, <span style="color:#8839ef">it</span>, release.await()))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="introducing-flows-in-gears">
  Introducing <code>Flow</code>s in Gears
  <a class="anchor" href="#introducing-flows-in-gears">#</a>
</h2>
<blockquote class="book-hint info">
  A similar abstraction of Kotlin <code>Flow</code>s can be implemented in Scala Gears leveraging <code>Task</code>s and <code>TerminableChannel</code>s.
The following section describes the attempt made to implement it and what has been achieved.
</blockquote>

<ul>
<li>When building the <code>Flow</code>, the client provides a block of code through which emits values, which is wrapped inside a <code>Task</code> that is started only when the <code>collect</code> method is called;</li>
<li>The values are sent (emitted) on a <code>TerminableChannel</code> which is created when the <code>collect</code> method is called;
<ul>
<li>the behavior of the <code>emit</code> method is defined inside the <code>apply</code> method of <code>Flow</code> and injected inside caller code via the context parameter <code>(it: FlowCollector[T]) ?=&gt;</code>.</li>
</ul>
</li>
<li>Once the task has finished, the channel is terminated.</li>
</ul>
<p>[<a href="https://github.com/tassiLuca/direct-style-experiments/blob/master/commons/src/main/scala/io/github/tassiLuca/dse/pimping/Flow.scala">Source code can be found in <code>commons</code> submodule, <code>pimpimg</code> package</a>.]</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** An asynchronous cold data stream that emits values, inspired to Kotlin Flows. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">+T</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#df8e1d">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** Start the flowing of data which can be collected reacting through the given [[collector]] function. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> collect<span style="color:#04a5e5;font-weight:bold">(</span>collector<span style="color:#8839ef">:</span> <span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">AsyncOperations</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** An interface modeling an entity capable of [[emit]]ting [[Flow]]s values. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">FlowCollector</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">-T</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#df8e1d">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** Emits a value to the flow. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> emit<span style="color:#04a5e5;font-weight:bold">(</span>value<span style="color:#8839ef">:</span> <span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">object</span> <span style="color:#df8e1d">Flow</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">/**</span> <span style="color:#d20f39">Creates</span> <span style="color:#d20f39">a</span> <span style="color:#d20f39">new</span> <span style="color:#d20f39">asynchronous</span> <span style="color:#d20f39">cold</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">]]</span> from the given <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">body</span><span style="color:#04a5e5;font-weight:bold">]].</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span> <span style="color:#df8e1d">Since</span> it is cold<span style="color:#04a5e5;font-weight:bold">,</span> it starts emitting values only when the <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">Flow.collect</span><span style="color:#04a5e5;font-weight:bold">]]</span> method is called<span style="color:#04a5e5;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*</span> <span style="color:#df8e1d">To</span> emit a value use the <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">FlowCollector</span><span style="color:#04a5e5;font-weight:bold">]]</span> given instance<span style="color:#04a5e5;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> apply<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">](</span>body<span style="color:#8839ef">:</span> <span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">it:</span> <span style="color:#d20f39">FlowCollector</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">])</span> <span style="color:#04a5e5;font-weight:bold">?=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> flow <span style="color:#8839ef">=</span> <span style="color:#df8e1d">FlowImpl</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]()</span>
</span></span><span style="display:flex;"><span>    flow<span style="color:#04a5e5;font-weight:bold">.</span>task <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Task</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#d20f39">val</span> <span style="color:#d20f39">channel</span> <span style="color:#04a5e5;font-weight:bold">=</span> flow<span style="color:#04a5e5;font-weight:bold">.</span>channel
</span></span><span style="display:flex;"><span>      flow<span style="color:#04a5e5;font-weight:bold">.</span>sync<span style="color:#04a5e5;font-weight:bold">.</span>release<span style="color:#04a5e5;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">val</span> collector<span style="color:#8839ef">:</span> <span style="color:#d20f39">FlowCollector</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#8839ef">new</span> <span style="color:#df8e1d">FlowCollector</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d20f39">override</span> <span style="color:#d20f39">def</span> <span style="color:#d20f39">emit</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">value:</span> <span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">)(</span><span style="color:#d20f39">using</span> <span style="color:#d20f39">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#d20f39">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span> channel<span style="color:#04a5e5;font-weight:bold">.</span>send<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Success</span><span style="color:#04a5e5;font-weight:bold">(</span>value<span style="color:#04a5e5;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">try</span> body<span style="color:#04a5e5;font-weight:bold">(</span>using collector<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">catch</span> <span style="color:#8839ef">case</span> e<span style="color:#8839ef">:</span> <span style="color:#d20f39">Exception</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> channel<span style="color:#04a5e5;font-weight:bold">.</span>send<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Failure</span><span style="color:#04a5e5;font-weight:bold">(</span>e<span style="color:#04a5e5;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    flow
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">private</span> <span style="color:#8839ef">class</span> <span style="color:#df8e1d">FlowImpl</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#df8e1d">extends</span> <span style="color:#df8e1d">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">private</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">var</span> task<span style="color:#8839ef">:</span> <span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Unit</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> uninitialized
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">private</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">var</span> channel<span style="color:#8839ef">:</span> <span style="color:#d20f39">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">=</span> uninitialized
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">private</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">val</span> sync <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Semaphore</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#fe640b">0</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> collect<span style="color:#04a5e5;font-weight:bold">(</span>collector<span style="color:#8839ef">:</span> <span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">AsyncOperations</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">val</span> myChannel <span style="color:#8839ef">=</span> <span style="color:#df8e1d">TerminableChannel</span><span style="color:#04a5e5;font-weight:bold">.</span>ofUnbounded<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>      synchronized<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#d20f39">channel</span> <span style="color:#04a5e5;font-weight:bold">=</span> myChannel
</span></span><span style="display:flex;"><span>        task<span style="color:#04a5e5;font-weight:bold">.</span>run<span style="color:#04a5e5;font-weight:bold">.</span>onComplete<span style="color:#04a5e5;font-weight:bold">(()</span> <span style="color:#8839ef">=&gt;</span> myChannel<span style="color:#04a5e5;font-weight:bold">.</span>terminate<span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>        <span style="color:#9ca0b0;font-style:italic">// Ensure to leave the synchronized block after the task has been initialized
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>        <span style="color:#9ca0b0;font-style:italic">// with the correct channel instance.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>        sync<span style="color:#04a5e5;font-weight:bold">.</span>acquire<span style="color:#04a5e5;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>      myChannel<span style="color:#04a5e5;font-weight:bold">.</span>foreach<span style="color:#04a5e5;font-weight:bold">(</span>t <span style="color:#8839ef">=&gt;</span> collector<span style="color:#04a5e5;font-weight:bold">(</span>t<span style="color:#04a5e5;font-weight:bold">))</span>
</span></span></code></pre></div><p><code>map</code> and <code>flatMap</code> combinators have been implemented on top of <code>Flow</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">object</span> <span style="color:#df8e1d">FlowOps</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">extension</span> <span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">](</span>flow<span style="color:#8839ef">:</span> <span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">T</span><span style="color:#04a5e5;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** @return a new [[Flow]] whose values has been transformed according to [[f]]. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> map<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">](</span>f<span style="color:#8839ef">:</span> <span style="color:#d20f39">T</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> R<span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#8839ef">new</span> <span style="color:#df8e1d">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#d20f39">override</span> <span style="color:#d20f39">def</span> <span style="color:#d20f39">collect</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">collector:</span> <span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">AsyncOperations</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        catchFailure<span style="color:#04a5e5;font-weight:bold">(</span>collector<span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#d20f39">flow.collect</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">item</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#d20f39">collector</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">Success</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">f</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">item.get</span><span style="color:#04a5e5;font-weight:bold">))))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** @return a new [[Flow]] whose values are created by flattening the flows generated
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">      *         by the given function [[f]] applied to each emitted value of this.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">      */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> flatMap<span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">](</span>f<span style="color:#8839ef">:</span> <span style="color:#d20f39">T</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#df8e1d">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">])</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#8839ef">new</span> <span style="color:#df8e1d">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#d20f39">override</span> <span style="color:#d20f39">def</span> <span style="color:#d20f39">collect</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">collector:</span> <span style="color:#d20f39">Try</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">R</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#df8e1d">Unit</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">AsyncOperations</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        catchFailure<span style="color:#04a5e5;font-weight:bold">(</span>collector<span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>          <span style="color:#d20f39">flow.collect</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">item</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#d20f39">f</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">item.get</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#d20f39">.collect</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">x</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span> <span style="color:#d20f39">collector</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">Success</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">x.get</span><span style="color:#04a5e5;font-weight:bold">))))</span>
</span></span></code></pre></div><h3 id="showcasing-flows">
  Showcasing <code>Flow</code>s
  <a class="anchor" href="#showcasing-flows">#</a>
</h3>
<p>Library use case:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">type</span> <span style="color:#d20f39">Name</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">String</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">type</span> <span style="color:#d20f39">WriterId</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">Int</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">type</span> <span style="color:#d20f39">Writer</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Name</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">WriterId</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">type</span> <span style="color:#d20f39">Book</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">String</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">object</span> <span style="color:#df8e1d">LibraryService</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">private</span> <span style="color:#d20f39">val</span> <span style="color:#d20f39">users:</span> <span style="color:#d20f39">Set</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Writer</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Set</span><span style="color:#04a5e5;font-weight:bold">((</span><span style="color:#40a02b">&#34;Alice&#34;</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#fe640b">987</span><span style="color:#04a5e5;font-weight:bold">),</span> <span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">&#34;Bob&#34;</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#fe640b">123</span><span style="color:#04a5e5;font-weight:bold">),</span> <span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">&#34;Charlie&#34;</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#fe640b">342</span><span style="color:#04a5e5;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">private</span> <span style="color:#8839ef">val</span> books<span style="color:#8839ef">:</span> <span style="color:#d20f39">Map</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">WriterId</span>, <span style="color:#d20f39">Set</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Book</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Map</span><span style="color:#04a5e5;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe640b">987</span> <span style="color:#04a5e5;font-weight:bold">-&gt;</span> <span style="color:#df8e1d">Set</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">&#34;Alice&#39;s Adventures in Wonderland&#34;</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#40a02b">&#34;Through the Looking-Glass&#34;</span><span style="color:#04a5e5;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe640b">123</span> <span style="color:#04a5e5;font-weight:bold">-&gt;</span> <span style="color:#df8e1d">Set</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">&#34;The Shining&#34;</span><span style="color:#04a5e5;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#fe640b">342</span> <span style="color:#04a5e5;font-weight:bold">-&gt;</span> <span style="color:#df8e1d">Set</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">&#34;The Raven&#34;</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#40a02b">&#34;The Tell-Tale Heart&#34;</span><span style="color:#04a5e5;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> allWriters<span style="color:#04a5e5;font-weight:bold">(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Writer</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Flow</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">users.foreach</span> <span style="color:#04a5e5;font-weight:bold">{</span> <span style="color:#d20f39">u</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#d20f39">sleep</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">2</span><span style="color:#8839ef">_</span><span style="color:#d20f39">000</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#d20f39">it.emit</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">u</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#04a5e5;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">def</span> booksByWriter<span style="color:#04a5e5;font-weight:bold">(</span>writer<span style="color:#8839ef">:</span> <span style="color:#d20f39">WriterId</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Book</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Flow</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">books</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">writer</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#d20f39">.foreach</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">it.emit</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span></code></pre></div><div class="book-columns flex flex-wrap">

  <div class="flex-even markdown-inner">
    <p><strong>Flows are cold</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#1e66f5;font-weight:bold">@main</span> <span style="color:#8839ef">def</span> useSimple<span style="color:#04a5e5;font-weight:bold">()</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">.</span>blocking<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">val</span> <span style="color:#d20f39">service</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">LibraryService</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> writers <span style="color:#8839ef">=</span> service<span style="color:#04a5e5;font-weight:bold">.</span>allWriters
</span></span><span style="display:flex;"><span>  log<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">s&#34;Not collecting yet!&#34;</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  sleep<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#fe640b">1</span>_000<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#9ca0b0;font-style:italic">// something meaningful
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>  log<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">&#34;Starting collecting users...&#34;</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  writers<span style="color:#04a5e5;font-weight:bold">.</span>collect<span style="color:#04a5e5;font-weight:bold">(</span>u <span style="color:#8839ef">=&gt;</span> log<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">s&#34;User: </span><span style="color:#40a02b">$u</span><span style="color:#40a02b">&#34;</span><span style="color:#04a5e5;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>  println<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">&#34;Done&#34;</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span></code></pre></div><p>What we get is something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>[1709559932492] Not collecting yet!
</span></span><span style="display:flex;"><span>[1709559933500] Starting collecting users...
</span></span><span style="display:flex;"><span>[1709559935532] User: Success((Alice,987))
</span></span><span style="display:flex;"><span>[1709559937536] User: Success((Bob,123))
</span></span><span style="display:flex;"><span>[1709559939541] User: Success((Charlie,342))
</span></span><span style="display:flex;"><span>Done
</span></span></code></pre></div><p>If something goes wrong during the task execution, a <code>Failure</code> is emitted and the task terminates (no more values are emitted).
For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">def</span> failingWriters<span style="color:#04a5e5;font-weight:bold">(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Flow</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Writer</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Flow</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">throw</span> <span style="color:#d20f39">IllegalStateException</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">&#34;</span><span style="color:#d20f39">Library</span> <span style="color:#d20f39">is</span> <span style="color:#d20f39">closed</span><span style="color:#d20f39">&#34;</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">it.emit</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">users.head</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d20f39">@main</span> <span style="color:#d20f39">def</span> <span style="color:#d20f39">useFailingFlow</span><span style="color:#04a5e5;font-weight:bold">()</span><span style="color:#d20f39">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">.</span>blocking<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">val</span> <span style="color:#d20f39">service</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">LibraryService</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> writers <span style="color:#8839ef">=</span> service<span style="color:#04a5e5;font-weight:bold">.</span>failingWriters
</span></span><span style="display:flex;"><span>  writers<span style="color:#04a5e5;font-weight:bold">.</span>collect<span style="color:#04a5e5;font-weight:bold">(</span>println<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span></code></pre></div><p>Results in:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>Failure(java.lang.IllegalStateException: 
</span></span><span style="display:flex;"><span>  The library is closed)
</span></span></code></pre></div>
  </div>

  <div class="flex-even markdown-inner">
    <p><strong>Flows can be transformed</strong></p>
<p><code>map</code>ping <code>Writer</code>s to their identifier:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#1e66f5;font-weight:bold">@main</span> <span style="color:#8839ef">def</span> useWithMapping<span style="color:#04a5e5;font-weight:bold">()</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">.</span>blocking<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">val</span> <span style="color:#d20f39">service</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">LibraryService</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> writersId <span style="color:#8839ef">=</span> service<span style="color:#04a5e5;font-weight:bold">.</span>allWriters<span style="color:#04a5e5;font-weight:bold">.</span>map<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#8839ef">_</span><span style="color:#04a5e5;font-weight:bold">.</span>_2<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  writersId<span style="color:#04a5e5;font-weight:bold">.</span>collect<span style="color:#04a5e5;font-weight:bold">(</span>a <span style="color:#8839ef">=&gt;</span> println<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#40a02b">s&#34;Id: </span><span style="color:#40a02b">$a</span><span style="color:#40a02b">&#34;</span><span style="color:#04a5e5;font-weight:bold">))</span>
</span></span></code></pre></div><p>Result:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>Id: Success(987)
</span></span><span style="display:flex;"><span>Id: Success(123)
</span></span><span style="display:flex;"><span>Id: Success(342)
</span></span></code></pre></div><p><code>flatMap</code>ping to get all the books:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#1e66f5;font-weight:bold">@main</span> <span style="color:#8839ef">def</span> useWithFlatMap<span style="color:#04a5e5;font-weight:bold">()</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Unit</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">.</span>blocking<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">val</span> <span style="color:#d20f39">service</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">LibraryService</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> allBooks <span style="color:#8839ef">=</span> service<span style="color:#04a5e5;font-weight:bold">.</span>allWriters<span style="color:#04a5e5;font-weight:bold">.</span>flatMap<span style="color:#04a5e5;font-weight:bold">(</span>w <span style="color:#8839ef">=&gt;</span> 
</span></span><span style="display:flex;"><span>    service<span style="color:#04a5e5;font-weight:bold">.</span>booksByWriter<span style="color:#04a5e5;font-weight:bold">(</span>w<span style="color:#04a5e5;font-weight:bold">.</span>_2<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  allBooks<span style="color:#04a5e5;font-weight:bold">.</span>collect<span style="color:#04a5e5;font-weight:bold">(</span>println<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span></code></pre></div><p>Result:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>Success(Alice&#39;s Adventures in Wonderland)
</span></span><span style="display:flex;"><span>Success(Through the Looking-Glass)
</span></span><span style="display:flex;"><span>Success(The Shining)
</span></span><span style="display:flex;"><span>Success(The Raven)
</span></span><span style="display:flex;"><span>Success(The Tell-Tale Heart)
</span></span></code></pre></div>
  </div>

</div>

<p>👉🏻 <a href="https://github.com/tassiLuca/direct-style-experiments/blob/master/commons/src/test/scala/io/github/tassiLuca/dse/pimping/FlowTest.scala">More tests on <code>Flows</code> can be found in <code>commons</code>, <code>pimping</code> pakcage</a>.</p>
<h2 id="takeaways">
  Takeaways
  <a class="anchor" href="#takeaways">#</a>
</h2>
<blockquote>
<ul>
<li><code>Channel</code>s are the basic communication and synchronization primitive for exchanging data between <code>Future</code>s/<code>Coroutine</code>s.
<ul>
<li>Scala Gears support for <code>Terminable</code> channels or a review of the closing mechanism should be considered.</li>
</ul>
</li>
<li>The <code>Flow</code> abstraction in Kotlin Coroutines is a powerful tool for handling cold streams of data, and it is a perfect fit for functions that need to return a stream of asynchronously computed values <em>upon request</em>.
<ul>
<li>A similar abstraction can be implemented in Scala Gears leveraging <code>Task</code>s and <code>TerminableChannel</code>s, enabling improved support for an asynchronous flow of data also in Gears, which is currently lacking.</li>
</ul>
</li>
</ul>
</blockquote>




  

<a  href="/direct-style-experiments/docs/03-basics/"   class="book-btn">
  <strong>Previous</strong>: Basic asynchronous constructs
</a>





  

<a  href="/direct-style-experiments/docs/05-rears/"   class="book-btn">
  <strong>Next</strong>: Reactivity in direct style
</a>

</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/tassiLuca/direct-style-experiments/commit/e79da73a556584040d0795f3da947e337040ae33" title='Last modified by Luca Tassinari | March 9, 2024' target="_blank" rel="noopener">
      <img src="/direct-style-experiments/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>March 9, 2024</span>
    </a>
  </div>




</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
</body>
</html>












