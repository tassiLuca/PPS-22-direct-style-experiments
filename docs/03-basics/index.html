<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Basic asynchronous constructs # Basic asynchronous constructs The need for a new Future construct Example: a blog posts service Structure Current monadic Future Direct style: Scala version with gears Kotlin Coroutines Takeaways The need for a new Future construct # The current implementation of the Future monadic construct suffers the following main cons:
Lack of referential transparency; Lack of cancellation mechanisms and structured concurrency; Accidental Sequentiality. To show these weaknesses in practice, a simple example of the core of a web service implementation is presented.">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="" />
<meta property="og:description" content="Basic asynchronous constructs # Basic asynchronous constructs The need for a new Future construct Example: a blog posts service Structure Current monadic Future Direct style: Scala version with gears Kotlin Coroutines Takeaways The need for a new Future construct # The current implementation of the Future monadic construct suffers the following main cons:
Lack of referential transparency; Lack of cancellation mechanisms and structured concurrency; Accidental Sequentiality. To show these weaknesses in practice, a simple example of the core of a web service implementation is presented." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://tassiluca.github.io/direct-style-experiments/docs/03-basics/" /><meta property="article:section" content="docs" />

<meta property="article:modified_time" content="2024-03-07T12:58:54+01:00" />

<title>03 Basics | direct-style-experiments</title>
<link rel="manifest" href="/direct-style-experiments/manifest.json">
<link rel="icon" href="/direct-style-experiments/favicon.png" >
<link rel="canonical" href="https://tassiluca.github.io/direct-style-experiments/docs/03-basics/">
<link rel="stylesheet" href="/direct-style-experiments/book.min.42504dd4648e8da78376617fd32b73c3ae6afbe9f805c36868bc831b07002332.css" integrity="sha256-QlBN1GSOjaeDdmF/0ytzw65q&#43;&#43;n4BcNoaLyDGwcAIzI=" crossorigin="anonymous">
  <script defer src="/direct-style-experiments/flexsearch.min.js"></script>
  <script defer src="/direct-style-experiments/en.search.min.bf3e6c4047a74032e851536a446a84e22354d1e9cd8c7448337ec5431e8104e4.js" integrity="sha256-vz5sQEenQDLoUVNqRGqE4iNU0enNjHRIM37FQx6BBOQ=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/direct-style-experiments/"><span>direct-style-experiments</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/direct-style-experiments/docs/01-overview/" class="">01 Overview</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/direct-style-experiments/docs/02-boundaries/" class="">02 Boundaries</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/direct-style-experiments/docs/03-basics/" class="active">03 Basics</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/direct-style-experiments/docs/04-channels/" class="">04 Channels</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/direct-style-experiments/docs/05-rears/" class="">05 Rears</a>
  

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/direct-style-experiments/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>03 Basics</strong>

  <label for="toc-control">
    
  </label>
</div>


  
 
      </header>

      
      
  <article class="markdown book-article"><h1 id="basic-asynchronous-constructs">
  Basic asynchronous constructs
  <a class="anchor" href="#basic-asynchronous-constructs">#</a>
</h1>
<ul>
<li><a href="#basic-asynchronous-constructs">Basic asynchronous constructs</a>
<ul>
<li><a href="#the-need-for-a-new-future-construct">The need for a new <code>Future</code> construct</a></li>
<li><a href="#example-a-blog-posts-service">Example: a blog posts service</a>
<ul>
<li><a href="#structure">Structure</a></li>
<li><a href="#current-monadic-future">Current monadic <code>Future</code></a></li>
<li><a href="#direct-style-scala-version-with-gears">Direct style: Scala version with <code>gears</code></a></li>
<li><a href="#kotlin-coroutines">Kotlin Coroutines</a></li>
</ul>
</li>
<li><a href="#takeaways">Takeaways</a></li>
</ul>
</li>
</ul>
<h2 id="the-need-for-a-new-future-construct">
  The need for a new <code>Future</code> construct
  <a class="anchor" href="#the-need-for-a-new-future-construct">#</a>
</h2>
<p>The current implementation of the <code>Future</code> monadic construct suffers the following main cons:</p>
<ul>
<li>Lack of <strong>referential transparency</strong>;</li>
<li>Lack of <strong>cancellation</strong> mechanisms and <strong>structured concurrency</strong>;</li>
<li><strong>Accidental Sequentiality</strong>.</li>
</ul>
<p>To show these weaknesses in practice, a simple example of the core of a web service implementation is presented.</p>
<h2 id="example-a-blog-posts-service">
  Example: a blog posts service
  <a class="anchor" href="#example-a-blog-posts-service">#</a>
</h2>
<blockquote class="book-hint info">
  <strong>Idea</strong>: develop a very simple (mocked) service that allows retrieving and storing from a repository blog posts, performing checks on the content and author before the actual storage.
</blockquote>

<p>The example has been implemented using:</p>
<ul>
<li>the continuation style through the current Scala <code>Future</code> monadic constructs;</li>
<li>the direct style, through:
<ul>
<li>the abstractions offered by <em>Gears</em>;</li>
<li><em>Kotlin coroutines</em>.</li>
</ul>
</li>
</ul>
<p>The example is organized into Gradle submodules:</p>
<ul>
<li><code>blog-ws-commons</code> contains code that has been reused for both the monadic and direct versions;</li>
<li><code>blog-ws-monadic</code> contains the monadic Scala style;</li>
<li><code>blog-ws-direct</code> contains the direct version using Scala Gears;</li>
<li><code>blog-ws-direct-kt</code> contains the direct version using Kotlin Coroutines.</li>
</ul>
<p>For this example just the tests are provided. You can explore them in the <code>test</code> folders and run via Gradle using the name of the submodule:</p>
<pre tabindex="0"><code>./gradlew :blog-ws-&lt;monadic | direct | direct-kt&gt;:test
</code></pre><h3 id="structure">
  Structure
  <a class="anchor" href="#structure">#</a>
</h3>
<p>The domain is modeled using abstract data types in a common <code>PostsModel</code> trait:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** The model of a simple blog posts service. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">PostsModel</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">/**</span> <span style="color:#d20f39">The</span> <span style="color:#d20f39">post</span> <span style="color:#d20f39">author</span><span style="color:#d20f39">&#39;</span><span style="color:#d20f39">s</span> <span style="color:#d20f39">identifier.</span> <span style="color:#d20f39">*/</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">type</span> <span style="color:#d20f39">AuthorId</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The posts title. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">type</span> <span style="color:#d20f39">Title</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The posts body. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">type</span> <span style="color:#d20f39">Body</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The content of the post. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">type</span> <span style="color:#d20f39">PostContent</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Title</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">Body</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** A post author and their info. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">case</span> <span style="color:#8839ef">class</span> <span style="color:#df8e1d">Author</span><span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#8839ef">:</span> <span style="color:#d20f39">AuthorId</span><span style="color:#04a5e5;font-weight:bold">,</span> name<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">,</span> surname<span style="color:#8839ef">:</span> <span style="color:#d20f39">String</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** A blog post, comprising an author, title, body and the last modification. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">case</span> <span style="color:#8839ef">class</span> <span style="color:#df8e1d">Post</span><span style="color:#04a5e5;font-weight:bold">(</span>author<span style="color:#8839ef">:</span> <span style="color:#d20f39">Author</span><span style="color:#04a5e5;font-weight:bold">,</span> title<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#8839ef">:</span> <span style="color:#d20f39">Body</span><span style="color:#04a5e5;font-weight:bold">,</span> lastModification<span style="color:#8839ef">:</span> <span style="color:#d20f39">Date</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** A function that verifies the content of the post, returning [[Right]] with the content of
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    * the post if the verification succeeds or [[Left]] with the reason why failed.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">type</span> <span style="color:#d20f39">ContentVerifier</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Title</span><span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">Body</span><span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#8839ef">=&gt;</span> <span style="color:#df8e1d">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">PostContent</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** A function that verifies the author has appropriate permissions, returning [[Right]]
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    * with their information or [[Left]] with the reason why failed.
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">    */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">type</span> <span style="color:#d20f39">AuthorsVerifier</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">AuthorId</span> <span style="color:#8839ef">=&gt;</span> <span style="color:#df8e1d">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Author</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span></code></pre></div><p>To implement the service two components have been conceived, following the Cake Pattern:</p>
<ul>
<li><code>PostsRepositoryComponent</code>
<ul>
<li>exposes the <code>Repository</code> trait allowing to store and retrieve blog posts;</li>
<li>mocks a DB technology with an in-memory collection.</li>
</ul>
</li>
<li><code>PostsServiceComponent</code>
<ul>
<li>is the component exposing the <code>Service</code> interface.</li>
<li>it could be called by the controller of the ReSTful web service.</li>
</ul>
</li>
</ul>
<p>Both must be designed in an async way.</p>
<h3 id="current-monadic-future">
  Current monadic <code>Future</code>
  <a class="anchor" href="#current-monadic-future">#</a>
</h3>
<p>The interface of the repository and services component of the monadic version are presented hereafter and their complete implementation is available <a href="https://github.com/tassiLuca/direct-style-experiments/tree/master/blog-ws-monadic/src/main/scala/io/github/tassiLuca/dse/blog">here</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** The component exposing blog posts repositories. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">PostsRepositoryComponent</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">context:</span> <span style="color:#d20f39">PostsModel</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The repository instance. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> repository<span style="color:#8839ef">:</span> <span style="color:#d20f39">PostsRepository</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The repository in charge of storing and retrieving blog posts. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">trait</span> <span style="color:#df8e1d">PostsRepository</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">/**</span> <span style="color:#d20f39">Save</span> <span style="color:#d20f39">the</span> <span style="color:#d20f39">given</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">post</span><span style="color:#04a5e5;font-weight:bold">]].</span> <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> save<span style="color:#04a5e5;font-weight:bold">(</span>post<span style="color:#8839ef">:</span> <span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** @return a [[Future]] completed with true if a post exists with 
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">      *         the given title, false otherwise. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> exists<span style="color:#04a5e5;font-weight:bold">(</span>postTitle<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Boolean</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** @return a [[Future]] completed either with a defined optional 
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">      *         post with given [[postTitle]] or an empty one. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> load<span style="color:#04a5e5;font-weight:bold">(</span>postTitle<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Option</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Load the post with the given [[postTitle]]. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> loadAll<span style="color:#04a5e5;font-weight:bold">()(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">LazyList</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** The component blog posts service. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">PostsServiceComponent</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">context:</span> <span style="color:#d20f39">PostsRepositoryComponent</span> <span style="color:#d20f39">&amp;</span> <span style="color:#d20f39">PostsModel</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The blog post service instance. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> service<span style="color:#8839ef">:</span> <span style="color:#d20f39">PostsService</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The service exposing a set of functionalities to interact with blog posts. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">trait</span> <span style="color:#df8e1d">PostsService</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">/**</span> <span style="color:#d20f39">Creates</span> <span style="color:#d20f39">a</span> <span style="color:#d20f39">new</span> <span style="color:#d20f39">blog</span> <span style="color:#d20f39">post</span> <span style="color:#d20f39">with</span> <span style="color:#d20f39">the</span> <span style="color:#d20f39">given</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">title</span><span style="color:#04a5e5;font-weight:bold">]]</span> and <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">body</span><span style="color:#04a5e5;font-weight:bold">]],</span> authored by <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">authorId</span><span style="color:#04a5e5;font-weight:bold">]].</span> <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> create<span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#8839ef">:</span> <span style="color:#d20f39">AuthorId</span><span style="color:#04a5e5;font-weight:bold">,</span> title<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#8839ef">:</span> <span style="color:#d20f39">Body</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Get a post from its [[title]]. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> get<span style="color:#04a5e5;font-weight:bold">(</span>title<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Option</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Gets all the stored blog posts in a lazy manner. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> all<span style="color:#04a5e5;font-weight:bold">()(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">LazyList</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span></code></pre></div><p>All the exposed functions, since they are asynchronous, return an instance of <code>Future[T]</code> and require to be called in a scope where a given instance of the <code>ExecutionContext</code> is declared.</p>
<p>What&rsquo;s important to delve into is the implementation of the service, and, more precisely, of the <code>create</code> method. As already mentioned, before saving the post two checks need to be performed:</p>
<ol>
<li>the post author must have permission to publish a post and their information needs to be retrieved (supposing they are managed by another service);</li>
<li>the content of the post is analyzed in order to prevent the storage and publication of inappropriate content.</li>
</ol>
<p>Since these operations are independent from each other they can be spawned and run in parallel.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> create<span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#8839ef">:</span> <span style="color:#d20f39">AuthorId</span><span style="color:#04a5e5;font-weight:bold">,</span> title<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#8839ef">:</span> <span style="color:#d20f39">Body</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">for</span>
</span></span><span style="display:flex;"><span>    exists <span style="color:#8839ef">&lt;-</span> context<span style="color:#04a5e5;font-weight:bold">.</span>repository<span style="color:#04a5e5;font-weight:bold">.</span>exists<span style="color:#04a5e5;font-weight:bold">(</span>title<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">if</span> <span style="color:#04a5e5;font-weight:bold">!</span>exists
</span></span><span style="display:flex;"><span>    post <span style="color:#8839ef">&lt;-</span> save<span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#04a5e5;font-weight:bold">,</span> title<span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">yield</span> post
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">private</span> <span style="color:#8839ef">def</span> save<span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#8839ef">:</span> <span style="color:#d20f39">AuthorId</span><span style="color:#04a5e5;font-weight:bold">,</span> title<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#8839ef">:</span> <span style="color:#d20f39">Body</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> authorAsync <span style="color:#8839ef">=</span> authorBy<span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> contentAsync <span style="color:#8839ef">=</span> verifyContent<span style="color:#04a5e5;font-weight:bold">(</span>title<span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">for</span>
</span></span><span style="display:flex;"><span>    content <span style="color:#8839ef">&lt;-</span> contentAsync
</span></span><span style="display:flex;"><span>    author <span style="color:#8839ef">&lt;-</span> authorAsync
</span></span><span style="display:flex;"><span>    post <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Post</span><span style="color:#04a5e5;font-weight:bold">(</span>author<span style="color:#04a5e5;font-weight:bold">,</span> content<span style="color:#04a5e5;font-weight:bold">.</span>_1<span style="color:#04a5e5;font-weight:bold">,</span> content<span style="color:#04a5e5;font-weight:bold">.</span>_2<span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">Date</span><span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">_</span> <span style="color:#8839ef">&lt;-</span> context<span style="color:#04a5e5;font-weight:bold">.</span>repository<span style="color:#04a5e5;font-weight:bold">.</span>save<span style="color:#04a5e5;font-weight:bold">(</span>post<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">yield</span> post
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/* Pretending to make a call to the Authorship Service that keeps track of authorized authors. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">private</span> <span style="color:#8839ef">def</span> authorBy<span style="color:#04a5e5;font-weight:bold">(</span>id<span style="color:#8839ef">:</span> <span style="color:#d20f39">AuthorId</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Author</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#04a5e5;font-weight:bold">???</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/* Some local computation that verifies the content of the post is appropriate. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">private</span> <span style="color:#8839ef">def</span> verifyContent<span style="color:#04a5e5;font-weight:bold">(</span>title<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#8839ef">:</span> <span style="color:#d20f39">Body</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">ExecutionContext</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Future</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">PostContent</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> <span style="color:#04a5e5;font-weight:bold">???</span>
</span></span></code></pre></div><p>This implementation shows the limits of the current monadic <code>Future</code> mechanism:</p>
<ul>
<li>
<p>if we want to achieve the serialization of futures execution we need to compose them using the <code>flatMap</code>, like in the <code>create</code> function: first, the check on the post existence is performed, and only if it is successful and another post with same title doesn&rsquo;t exist the <code>save</code> function is started</p>
<ul>
<li>
<p>as a consequence, if we want two futures to run in parallel we have to spawn them before the <code>for-yield</code>, as in the <code>save</code> function. This is error-prone and could lead to unexpected sequentiality, like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">// THIS IS WRONG: the two futures are started sequentially!
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span><span style="color:#8839ef">for</span>
</span></span><span style="display:flex;"><span>  content <span style="color:#8839ef">&lt;-</span> verifyContent<span style="color:#04a5e5;font-weight:bold">(</span>title<span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  author <span style="color:#8839ef">&lt;-</span> authorBy<span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  post <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Post</span><span style="color:#04a5e5;font-weight:bold">(</span>author<span style="color:#04a5e5;font-weight:bold">,</span> content<span style="color:#04a5e5;font-weight:bold">.</span>_1<span style="color:#04a5e5;font-weight:bold">,</span> content<span style="color:#04a5e5;font-weight:bold">.</span>_2<span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">Date</span><span style="color:#04a5e5;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">_</span> <span style="color:#8839ef">&lt;-</span> context<span style="color:#04a5e5;font-weight:bold">.</span>repository<span style="color:#04a5e5;font-weight:bold">.</span>save<span style="color:#04a5e5;font-weight:bold">(</span>post<span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">yield</span> post
</span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>since the publication of a post can be performed only if both of these checks succeed, it is desirable that, whenever one of the two fails, the other gets canceled.
Unfortunately, currently, Scala Futures are not cancellable and provide no <em>structured concurrency</em> mechanism.</p>
</li>
<li>
<p>moreover, they lack referential transparency, i.e. future starts running when they are defined. This means that passing a reference to a future is not the same as passing the referenced expression.</p>
</li>
</ul>
<h3 id="direct-style-scala-version-with-gears">
  Direct style: Scala version with <code>gears</code>
  <a class="anchor" href="#direct-style-scala-version-with-gears">#</a>
</h3>
<p>The API of the gears library is presented hereafter and is built on top of four main abstractions, three of which are here presented (the fourth in the next example):</p>
<ol>
<li><strong><code>Async</code></strong> context is <strong>&ldquo;a capability that allows a computation to suspend while waiting for the result of an async source&rdquo;</strong>. Code that has access to an instance of the <code>Async</code> trait is said to be in an async context and can suspend its execution. Usually, it is provided via <code>given</code> instances.
<ul>
<li>A common way to obtain an <code>Async</code> instance is to use an <code>Async.blocking</code>.</li>
</ul>
</li>
<li><strong><code>Async.Source</code></strong> model an asynchronous source of data that can be polled or awaited by suspending the computation, as well as composed using combinator functions.</li>
<li><strong><code>Future</code>s</strong> are the primary (in fact, the only) active elements that encapsulate a control flow that, eventually, will deliver a result (either a computed or a failure value that contains an exception). Since <code>Future</code>s are <code>Async.Source</code>s can be awaited and combined with other <code>Future</code>s, suspending their execution.
<ul>
<li><strong><code>Task</code>s</strong> are the abstraction created to create delayed <code>Future</code>s, responding to the lack of referential transparency problem. They take the body of a <code>Future</code> as an argument; its <code>run</code> method converts that body to a <code>Future</code>, starting its execution.</li>
<li><strong><code>Promise</code>s</strong> allow us to define <code>Future</code>&rsquo;s result value externally, instead of executing a specific body of code.</li>
</ul>
</li>
</ol>


<script src="/direct-style-experiments/mermaid.min.js"></script>

  <script>mermaid.initialize({
    "flowchart": {
        "useMaxWidth":true
    },
    "theme": "default"
})</script>




<p class="mermaid">
classDiagram
  class Async {
    << trait >>
    +group: CompletionGroup
    +withGroup(group: CompletionGroup) Async
    +await[T](src: Async.Source[T]) T
    +current() Async$
    +blocking[T](body: Async ?=> T) T$
    +group[T](body: Async ?=> T) T$
  }

  class `Async.Source[+T]` {
    << trait >>
    +poll(k: Listener[T]) Boolean
    +poll() Option[T]
    +onComplete(k: Listener[T])
    +dropListener(k: Listener[T])
    +awaitResult()(using Async) T
  }

  Async *--> `Async.Source[+T]`

  class OriginalSource {
    << abstract class >>
  }
  `Async.Source[+T]` <|-- OriginalSource

  class `Listener[-T]` {
    << trait >>
    +lock: Listener.ListenerLock | Null
    +complete(data: T, source: Async.Source[T])
    +completeNow(data: T, source: Async.Source[T]) Boolean
    +apply[T](consumer: (T, Source[T]) => Unit) Listener[T]$
  }

  `Async.Source[+T]` *--> `Listener[-T]`

  class `Future[+T]` {
    << trait >>
    +apply[T](body: Async ?=> T) Future[T]$
    +now[T](result: Try[T]) Future[T]
    +zip[U](f2: Future[U]) Future[T, U]
    +alt(f2: Future[T]) Future[T]
    +altWithCancel(f2: Future[T]) Future[T]
  }
  class `Promise[+T]` {
    << trait >>
    +apply() Promise[T]$
    +asFuture Future[T]
    +complete(result: Try[T])
  }
  OriginalSource <|-- `Future[+T]`
  `Future[+T]` <|-- `Promise[+T]`

  class `Task[+T]` {
    +apply(body: (Async, AsyncOperations) ?=> T) Task[T]$
    +run(using Async, AsyncOperations) Future[+T]
  }
  `Future[+T]` <--* `Task[+T]`

  class Cancellable {
    << trait >>
    +group: CompletionGroup
    +cancel()
    +link(group: CompletionGroup)
    +unlink()
  }

  Cancellable <|-- `Future[+T]`

  class Tracking {
    << trait >>
    +isCancelled Boolean
  }
  Cancellable <|-- Tracking

  class CompletionGroup {
    +add(member: Cancellable)
    +drop(member: Cancellable)
  }
  Tracking <|-- CompletionGroup

  Async *--> CompletionGroup

</p>

<p>Going back to our example, the interface of both the repository and service components becomes (<a href="https://github.com/tassiLuca/direct-style-experiments/tree/master/blog-ws-direct/src/main/scala/io/github/tassiLuca/dse/blog">here</a> you can find the complete sources):</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** The component exposing blog posts repositories. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">PostsRepositoryComponent</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">context:</span> <span style="color:#d20f39">PostsModel</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The repository instance. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> repository<span style="color:#8839ef">:</span> <span style="color:#d20f39">PostsRepository</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The repository in charge of storing and retrieving blog posts. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">trait</span> <span style="color:#df8e1d">PostsRepository</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">/**</span> <span style="color:#d20f39">Save</span> <span style="color:#d20f39">the</span> <span style="color:#d20f39">given</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">post</span><span style="color:#04a5e5;font-weight:bold">]].</span> <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> save<span style="color:#04a5e5;font-weight:bold">(</span>post<span style="color:#8839ef">:</span> <span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Return true if a post exists with the given title, false otherwise. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> exists<span style="color:#04a5e5;font-weight:bold">(</span>postTitle<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Boolean</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Load the post with the given [[postTitle]]. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> load<span style="color:#04a5e5;font-weight:bold">(</span>postTitle<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Option</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Load all the saved post. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> loadAll<span style="color:#04a5e5;font-weight:bold">()(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">LazyList</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** The blog posts service component. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">trait</span> <span style="color:#df8e1d">PostsServiceComponent</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#d20f39">context:</span> <span style="color:#d20f39">PostsRepositoryComponent</span> <span style="color:#d20f39">&amp;</span> <span style="color:#d20f39">PostsModel</span> <span style="color:#04a5e5;font-weight:bold">=&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The blog post service instance. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">val</span> service<span style="color:#8839ef">:</span> <span style="color:#d20f39">PostsService</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">/** The service exposing a set of functionalities to interact with blog posts. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8839ef">trait</span> <span style="color:#df8e1d">PostsService</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">/**</span> <span style="color:#d20f39">Creates</span> <span style="color:#d20f39">a</span> <span style="color:#d20f39">new</span> <span style="color:#d20f39">blog</span> <span style="color:#d20f39">post</span> <span style="color:#d20f39">with</span> <span style="color:#d20f39">the</span> <span style="color:#d20f39">given</span> <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">title</span><span style="color:#04a5e5;font-weight:bold">]]</span> and <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">body</span><span style="color:#04a5e5;font-weight:bold">]],</span> authored by <span style="color:#04a5e5;font-weight:bold">[[</span><span style="color:#d20f39">authorId</span><span style="color:#04a5e5;font-weight:bold">]],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#04a5e5;font-weight:bold">*</span> or a string explaining the reason of the failure<span style="color:#04a5e5;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>      <span style="color:#04a5e5;font-weight:bold">*/</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> create<span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#8839ef">:</span> <span style="color:#d20f39">AuthorId</span><span style="color:#04a5e5;font-weight:bold">,</span> title<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#8839ef">:</span> <span style="color:#d20f39">Body</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Get a post from its [[title]] or a string explaining the reason of the failure. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> get<span style="color:#04a5e5;font-weight:bold">(</span>title<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Option</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Gets all the stored blog posts in a lazy manner or a string explaining the reason of the failure. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">def</span> all<span style="color:#04a5e5;font-weight:bold">()(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">LazyList</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]]</span>
</span></span></code></pre></div><p>As you can see, <code>Future</code>s are gone and the return type it&rsquo;s just the result of their intent (expressed with <code>Either</code> to return a meaningful message in case of failure). The fact they are <em>suspendable</em> is expressed using the <code>Async</code> context, which is required to invoke those functions.</p>
<blockquote>
<p>Key inspiring principle (actually, taken by Kotlin)</p>
<p><em><strong>❝Concurrency is hard! Concurrency has to be explicit!❞</strong></em></p>
</blockquote>
<p>By default the code is serial. If you want to opt-in concurrency you have to explicitly use a <code>Future</code> or <code>Task</code> spawning a new control flow that executes asynchronously, allowing the caller to continue its execution.</p>
<p>The other important key feature of the library is the support for <strong>structured concurrency and cancellation mechanisms</strong>:</p>
<ul>
<li>
<p><code>Future</code>s are <code>Cancellable</code> instances;</p>
<ul>
<li>
<p>When you cancel a future using the <code>cancel()</code> method, it promptly sets its value to <code>Failure(CancellationException)</code>. Additionally, if it&rsquo;s a runnable future, the thread associated with it is interrupted using <code>Thread.interrupt()</code>.</p>
</li>
<li>
<p>to avoid immediate cancellation, deferring the cancellation after some block, is possible using <code>uninterruptible</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">val</span> f <span style="color:#8839ef">=</span> <span style="color:#df8e1d">Future</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>  <span style="color:#9ca0b0;font-style:italic">// this can be interrupted
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>  uninterruptible<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">// this cannot be interrupted *immediately*
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>  <span style="color:#9ca0b0;font-style:italic">// this can be interrupted
</span></span></span></code></pre></div></li>
</ul>
</li>
<li>
<p><code>Future</code>s are nestable; <strong>the lifetime of nested computations is contained within the lifetime of enclosing ones</strong>. This is achieved using <strong><code>CompletionGroup</code>s</strong>, which are cancellable objects themselves and serve as <strong>containers for other cancellable objects</strong>; <strong>once they are canceled, all of their members are canceled as well</strong>.</p>
<ul>
<li>The group is accessible through <code>Async.current.group</code>;</li>
<li>A cancellable object can be included inside the cancellation group of the async context using the <code>link</code> method; this is what the <a href="https://github.com/lampepfl/gears/blob/07989ffdae153b2fe11ac1ece53ce9dd1dbd18ef/shared/src/main/scala/async/futures.scala#L140">implementation of the <code>Future</code> does, under the hood</a>.</li>
</ul>
</li>
</ul>
<p>The implementation of the <code>create</code> function with direct style in Gears looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#8839ef">override</span> <span style="color:#8839ef">def</span> create<span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#8839ef">:</span> <span style="color:#d20f39">AuthorId</span><span style="color:#04a5e5;font-weight:bold">,</span> title<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#8839ef">:</span> <span style="color:#d20f39">Body</span><span style="color:#04a5e5;font-weight:bold">)(</span>using <span style="color:#df8e1d">Async</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Post</span><span style="color:#04a5e5;font-weight:bold">]</span> <span style="color:#8839ef">=</span> 
</span></span><span style="display:flex;"><span>  either<span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">if</span> <span style="color:#d20f39">context.repository.exists</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">title</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#d20f39">.?</span> <span style="color:#d20f39">then</span> <span style="color:#d20f39">left</span><span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#d20f39">s</span><span style="color:#d20f39">&#34;</span><span style="color:#d20f39">A</span> <span style="color:#d20f39">post</span> <span style="color:#d20f39">entitled</span> <span style="color:#d20f39">$title</span> <span style="color:#d20f39">already</span> <span style="color:#d20f39">exists</span><span style="color:#d20f39">&#34;</span><span style="color:#04a5e5;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#d20f39">val</span> <span style="color:#d20f39">f</span> <span style="color:#04a5e5;font-weight:bold">=</span> <span style="color:#df8e1d">Future</span><span style="color:#8839ef">:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#d20f39">val</span> <span style="color:#d20f39">content</span> <span style="color:#04a5e5;font-weight:bold">=</span> verifyContent<span style="color:#04a5e5;font-weight:bold">(</span>title<span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#04a5e5;font-weight:bold">).</span>run
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">val</span> author <span style="color:#8839ef">=</span> authorBy<span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#04a5e5;font-weight:bold">).</span>run
</span></span><span style="display:flex;"><span>      content<span style="color:#04a5e5;font-weight:bold">.</span>zip<span style="color:#04a5e5;font-weight:bold">(</span>author<span style="color:#04a5e5;font-weight:bold">).</span>await
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> <span style="color:#04a5e5;font-weight:bold">(</span>post<span style="color:#04a5e5;font-weight:bold">,</span> author<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#8839ef">=</span> f<span style="color:#04a5e5;font-weight:bold">.</span>awaitResult<span style="color:#04a5e5;font-weight:bold">.?</span>
</span></span><span style="display:flex;"><span>    context<span style="color:#04a5e5;font-weight:bold">.</span>repository<span style="color:#04a5e5;font-weight:bold">.</span>save<span style="color:#04a5e5;font-weight:bold">(</span><span style="color:#df8e1d">Post</span><span style="color:#04a5e5;font-weight:bold">(</span>author<span style="color:#04a5e5;font-weight:bold">.?,</span> post<span style="color:#04a5e5;font-weight:bold">.?.</span>_1<span style="color:#04a5e5;font-weight:bold">,</span> post<span style="color:#04a5e5;font-weight:bold">.?.</span>_2<span style="color:#04a5e5;font-weight:bold">,</span> <span style="color:#df8e1d">Date</span><span style="color:#04a5e5;font-weight:bold">())).?</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/* Pretending to make a call to the Authorship Service that keeps track of authorized authors. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">private</span> <span style="color:#8839ef">def</span> authorBy<span style="color:#04a5e5;font-weight:bold">(</span>id<span style="color:#8839ef">:</span> <span style="color:#d20f39">AuthorId</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">Author</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">=</span> <span style="color:#04a5e5;font-weight:bold">???</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/* Some local computation that verifies the content of the post is appropriate. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">private</span> <span style="color:#8839ef">def</span> verifyContent<span style="color:#04a5e5;font-weight:bold">(</span>title<span style="color:#8839ef">:</span> <span style="color:#d20f39">Title</span><span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#8839ef">:</span> <span style="color:#d20f39">Body</span><span style="color:#04a5e5;font-weight:bold">)</span><span style="color:#8839ef">:</span> <span style="color:#d20f39">Task</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">Either</span><span style="color:#04a5e5;font-weight:bold">[</span><span style="color:#d20f39">String</span>, <span style="color:#d20f39">PostContent</span><span style="color:#04a5e5;font-weight:bold">]]</span> <span style="color:#8839ef">=</span> <span style="color:#04a5e5;font-weight:bold">???</span>
</span></span></code></pre></div><p>Some remarks:</p>
<ul>
<li>the <code>either</code> boundary have been used to quickly return a <code>Right[String, Post]</code> object in case something goes wrong;</li>
<li><code>authorBy</code> and <code>verifyContent</code> returns referential transparent <code>Task</code> instances. Running them spawns a new <code>Future</code> instance;</li>
<li>Thanks to structured concurrency and <code>zip</code> combinator we can obtain that if one of the nested two futures fails the enclosing future is cancelled, cancelling also all its unterminated children
<ul>
<li>
<p><code>zip</code>: combinator function returning a pair with the results if both <code>Future</code>s succeed, otherwise fail with the failure that was returned first.</p>
</li>
<li>
<p>Be aware of the fact to achieve cancellation is necessary to enclose both the content verification and authorization task inside an enclosing <code>Future</code>, since the <code>zip</code> doesn&rsquo;t provide a cancellation mechanism per se. The following code wouldn&rsquo;t work as expected!</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">// WRONG: doesn&#39;t provide cancellation!
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span><span style="color:#8839ef">val</span> contentVerifier <span style="color:#8839ef">=</span> verifyContent<span style="color:#04a5e5;font-weight:bold">(</span>title<span style="color:#04a5e5;font-weight:bold">,</span> body<span style="color:#04a5e5;font-weight:bold">).</span>run
</span></span><span style="display:flex;"><span><span style="color:#8839ef">val</span> authorizer <span style="color:#8839ef">=</span> authorBy<span style="color:#04a5e5;font-weight:bold">(</span>authorId<span style="color:#04a5e5;font-weight:bold">).</span>run
</span></span><span style="display:flex;"><span><span style="color:#8839ef">val</span> <span style="color:#04a5e5;font-weight:bold">(</span>post<span style="color:#04a5e5;font-weight:bold">,</span> author<span style="color:#04a5e5;font-weight:bold">)</span> <span style="color:#8839ef">=</span> contentVerifier<span style="color:#04a5e5;font-weight:bold">.</span>zip<span style="color:#04a5e5;font-weight:bold">(</span>authorizer<span style="color:#04a5e5;font-weight:bold">).</span>awaitResult<span style="color:#04a5e5;font-weight:bold">.?</span>
</span></span></code></pre></div></li>
</ul>
</li>
</ul>
<p>👉🏻 To showcase the structured concurrency and cancellation mechanisms of Scala Gears tests have been prepared:</p>
<ul>
<li><a href="https://github.com/tassiLuca/direct-style-experiments/blob/master/commons/src/test/scala/io/github/tassiLuca/dse/StructuredConcurrencyTest.scala"><code>StructuredConcurrencyTest</code></a></li>
<li><a href="https://github.com/tassiLuca/direct-style-experiments/blob/master/commons/src/test/scala/io/github/tassiLuca/dse/CancellationTest.scala"><code>CancellationTest</code></a></li>
</ul>
<p>Other combinator methods, available on <code>Future</code>s instance:</p>
<table>
<thead>
<tr>
<th><strong>Combinator</strong></th>
<th><strong>Goal</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Future[T].zip(Future[U])</code></td>
<td>Parallel composition of two futures. If both futures succeed, succeed with their values in a pair. Otherwise, fail with the failure that was returned first</td>
</tr>
<tr>
<td><code>Future[T].alt(Future[T])</code> / <code>Seq[Future[T]].altAll</code></td>
<td>Alternative parallel composition. If either task succeeds, succeed with the success that was returned first. Otherwise, fail with the failure that was returned last (race all futures).</td>
</tr>
<tr>
<td><code>Future[T].altWithCancel(Future[T])</code> / <code>Seq[Future[T]].altAllWithCancel</code></td>
<td>Like <code>alt</code> but the slower future is cancelled.</td>
</tr>
<tr>
<td><code>Seq[Future[T]].awaitAll</code></td>
<td><code>.await</code> for all futures in the sequence, returns the results in a sequence, or throws if any futures fail.</td>
</tr>
<tr>
<td><code>Seq[Future[T]].awaitAllOrCancel</code></td>
<td>Like <code>awaitAll</code>, but cancels all futures as soon as one of them fails.</td>
</tr>
</tbody>
</table>
<h3 id="kotlin-coroutines">
  Kotlin Coroutines
  <a class="anchor" href="#kotlin-coroutines">#</a>
</h3>
<ul>
<li>
<p>A <strong>coroutine</strong> in Kotlin is an instance of a <em>suspendable</em> computation.</p>
</li>
<li>
<p>Their API is quite similar to the Scala Gears, which has taken inspiration from Kotlin coroutines. To try to make a comparison, the following table shows the correspondence between the two libraries:</p>
<table>
<thead>
<tr>
<th><strong>Scala Gears</strong></th>
<th><strong>Kotlin Coroutines</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Async</code></td>
<td><code>CoroutineScope</code></td>
</tr>
<tr>
<td><code>Future[Unit]</code></td>
<td><code>Job</code></td>
</tr>
<tr>
<td><code>Future[T]</code></td>
<td><code>Deferred&lt;T&gt;</code></td>
</tr>
<tr>
<td><code>def all()(using Async)</code></td>
<td><code>suspend fun all()</code></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>In the Kotlin Coroutine library, <code>CoroutineScope</code> is an interface that defines a single property, <code>coroutineContext</code>, which returns the <code>CoroutineContext</code> that defines the scope in which the coroutine runs.</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span>  <span style="color:#8839ef">public</span> <span style="color:#8839ef">interface</span> <span style="color:#df8e1d">CoroutineScope</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#9ca0b0;font-style:italic">/** Returns the context of this scope. */</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8839ef">public</span> <span style="color:#8839ef">val</span> <span style="color:#fe640b">coroutineContext</span>: CoroutineContext
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><p>Every coroutine must be executed in a coroutine context, which is a collection of key-value pairs that provide contextual information for the coroutine, including a dispatcher, that determines what thread or threads the coroutine uses for its execution, and the <code>Job</code> of the coroutine, which represents a cancellable background piece of work with a life cycle that culminates in its completion.</p>
<ul>
<li>
<p>Different ways to create a scope:</p>
<ul>
<li><code>GlobalScope.launch</code> launching a new coroutine in the global scope &ndash; <em>discouraged because it can lead to memory leaks</em>;</li>
<li><code>CoroutineScope(Dispatchers.Default)</code>, using the constructor with a dispatcher;</li>
<li><code>runBlocking</code> - equivalent to the Gears <code>Async.blocking</code> - provides a way to run a coroutine in the <code>MainScope</code>, i.e. on the main/UI thread.</li>
</ul>
</li>
<li>
<p>Useful dispatchers:</p>
<ul>
<li><code>Default dispatcher</code>: to run CPU-intensive functions. If we forget to choose our dispatcher, this dispatcher will be selected by default;</li>
<li><code>IO dispatcher</code>: to run I-O bound computation, where we block waiting for input-output operations to complete, like network-related operations, file operations, etc.;</li>
<li><code>Unconfined dispatcher</code>: it isn&rsquo;t restricted to a particular thread, i.e. doesn&rsquo;t change the thread of the coroutine, it operates on the same thread where it was initiated;</li>
<li><code>Main dispatcher</code>: used when we want to interact with the UI. It is restricted to the main thread.</li>
</ul>
</li>
<li>
<p>Several coroutine builders exist, like <code>launch</code>, <code>async</code>, <code>withContext</code> which accept an optional <code>CoroutineContext</code> parameter that can be used to specify the dispatcher and other context elements.</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">fun</span> <span style="color:#1e66f5">main</span>(): Unit = runBlocking { <span style="color:#9ca0b0;font-style:italic">// this: CoroutineScope
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    <span style="color:#8839ef">val</span> <span style="color:#fe640b">job</span>: Job = <span style="color:#8839ef">this</span>.launch(<span style="color:#df8e1d">Dispatchers</span>.IO) { <span style="color:#9ca0b0;font-style:italic">// launch a new coroutine and continue
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>        delay(<span style="color:#fe640b">1000L</span>) <span style="color:#9ca0b0;font-style:italic">// non-blocking delay for 1 second (default time unit is ms)
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>        print(<span style="color:#40a02b">&#34;Kotlin Coroutine!&#34;</span>) <span style="color:#9ca0b0;font-style:italic">// print after delay
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">val</span> <span style="color:#fe640b">job2</span>: Deferred&lt;String&gt; = async {
</span></span><span style="display:flex;"><span>        delay(<span style="color:#fe640b">100L</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#40a02b">&#34;Hello&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    print(job2.await() + <span style="color:#40a02b">&#34; &#34;</span>) <span style="color:#9ca0b0;font-style:italic">// wait until child coroutine completes
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>    job.join() <span style="color:#9ca0b0;font-style:italic">// wait until the job is done and &#34;Kotlin Coroutine!&#34; is printed
</span></span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic"></span>}
</span></span></code></pre></div></li>
<li>
<p>suspending functions are marked with the <code>suspend</code> keyword; they can use other suspending functions to suspend the execution of a coroutine.</p>
</li>
</ul>
</li>
<li>
<p>Coroutines follow the principle of structured concurrency: coroutines can be arranged into parent-child hierarchies where the cancellation of a parent leads to the immediate cancellation of all its children recursively. Failure of a child with an exception immediately cancels its parent and, consequently, all its other children.</p>
</li>
</ul>
<p>Going back to our example, the interface of the service with Kotlin coroutines looks like this (<a href="https://github.com/tassiLuca/direct-style-experiments/tree/master/blog-ws-direct-kt/src/main/kotlin/io/github/tassiLuca/dse/blog">here</a> you can find the complete sources):</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/** The service exposing a set of functionalities to interact with blog posts. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">interface</span> <span style="color:#df8e1d">PostsService</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Creates a new post. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">create</span>(authorId: String, title: String, body: String): Result&lt;Post&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Retrieves a post by its title. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">get</span>(title: String): Result&lt;Post&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#9ca0b0;font-style:italic">/** Retrieves all the posts. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">getAll</span>(): Result&lt;Sequence&lt;Post&gt;&gt;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The implementation of the <code>create</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#4c4f69;background-color:#eff1f5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-kotlin" data-lang="kotlin"><span style="display:flex;"><span><span style="color:#8839ef">override</span> <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">create</span>(authorId: String, title: String, body: String): Result&lt;Post&gt; = runCatching {
</span></span><span style="display:flex;"><span>    coroutineScope {
</span></span><span style="display:flex;"><span>        require(!repository.exists(title)) { <span style="color:#40a02b">&#34;Post with title </span><span style="color:#40a02b">$title</span><span style="color:#40a02b"> already exists&#34;</span> }
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">val</span> <span style="color:#fe640b">content</span> = async { verifyContent(title, body) }
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">val</span> <span style="color:#fe640b">author</span> = async { authorBy(authorId) }
</span></span><span style="display:flex;"><span>        <span style="color:#8839ef">val</span> <span style="color:#fe640b">post</span> = Post(author.await(), content.await(), Date())
</span></span><span style="display:flex;"><span>        repository.save(post)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/* Pretending to make a call to the Authorship Service that keeps track of authorized authors. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">private</span> <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">authorBy</span>(id: String): Author { <span style="color:#04a5e5;font-weight:bold">..</span>. }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#9ca0b0;font-style:italic">/* Some local computation that verifies the content of the post is appropriate. */</span>
</span></span><span style="display:flex;"><span><span style="color:#8839ef">private</span> <span style="color:#8839ef">suspend</span> <span style="color:#8839ef">fun</span> <span style="color:#1e66f5">verifyContent</span>(title: String, body: String): PostContent { <span style="color:#04a5e5;font-weight:bold">..</span>. }
</span></span></code></pre></div><ul>
<li>a <code>coroutineScope</code> is a suspending function used to create a new coroutine scope: it suspends the execution of the current coroutine, releasing the underlying thread for other usages;</li>
<li>As we said previously, the failure of a child with an exception immediately cancels its parent and, consequently, all its other children: this means that, for handling the cancellation of nested coroutines, we don&rsquo;t need to do anything special
<ul>
<li>with <code>coroutineScope</code> no matter the order in which coroutines are awaited, if one of them fails with an exception it is propagated upwards, cancelling all other ones
<ul>
<li>this is not the case for <code>supervisorScope</code>, a coroutine builder ensuring that child coroutines can fail independently without affecting the parent coroutine.</li>
<li>have a look to <a href="https://github.com/tassiLuca/direct-style-experiments/blob/master/blog-ws-direct-kt/src/test/kotlin/io/github/tassiLuca/dse/CoroutinesCancellationTests.kt">this test</a></li>
</ul>
</li>
<li>This is an advantage over the Scala Gears, where operators like <code>zip</code> and <code>altWithCancel</code> are necessary!</li>
</ul>
</li>
</ul>
<h2 id="takeaways">
  Takeaways
  <a class="anchor" href="#takeaways">#</a>
</h2>
<blockquote>
<ul>
<li>Scala Gears offers, despite the syntactical differences, very similar concepts to Kotlin Coroutines, with structured concurrency and cancellation mechanisms;</li>
<li>Kotlin Coroutines handles the cancellation of nested coroutines more easily than Scala Gears, where special attention is required;</li>
<li>As <a href="https://github.com/lampepfl/gears/issues/19#issuecomment-1732586362">stated by M. Odersky</a> the <code>Async</code> capability is better than <code>suspend</code> because let defines functions that work for synchronous as well as asynchronous function arguments without changing anything, while in Kotlin suspendable functions passed as an argument in higher-order functions must be tagged with <code>suspend</code> keyword.</li>
</ul>
</blockquote>




  

<a  href="/direct-style-experiments/docs/02-boundaries/"   class="book-btn">
  <strong>Previous</strong>: boundary &amp; break
</a>





  

<a  href="/direct-style-experiments/docs/04-channels/"   class="book-btn">
  <strong>Next</strong>: Channels as a communication primitive
</a>

</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/tassiLuca/direct-style-experiments/commit/e61044e3afd86718ea14d14cd1442f44e99a713e" title='Last modified by Luca Tassinari | March 7, 2024' target="_blank" rel="noopener">
      <img src="/direct-style-experiments/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>March 7, 2024</span>
    </a>
  </div>




</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  </main>

  
</body>
</html>












